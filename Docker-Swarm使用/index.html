<!doctype html>
<html lang="zh"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta><title>Docker Swarm使用 - buubiu&#039;s技术分享主页</title><link rel="manifest" href="/manifest.json"><meta name="application-name" content="buubiu&#039;s技术分享主页"><meta name="msapplication-TileImage" content="/img/common/favicon.ico"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="buubiu&#039;s技术分享主页"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta name="description" content="简介官方：https:&amp;#x2F;&amp;#x2F;docs.docker.com&amp;#x2F;engine&amp;#x2F;swarm&amp;#x2F; Docker Swarm 是 Docker 官方项目之一，提供 Docker 容器集群服务，是 Docker 官方对容器云生态进行支持的核心方案。使用它，用户可以将多个 Docker 主机封装为单个大型的虚拟 Docker 主机，快速打造一套容器云平台。"><meta property="og:type" content="blog"><meta property="og:title" content="Docker Swarm使用"><meta property="og:url" content="https://blog.buubiu.com/Docker-Swarm%E4%BD%BF%E7%94%A8/"><meta property="og:site_name" content="buubiu&#039;s技术分享主页"><meta property="og:description" content="简介官方：https:&amp;#x2F;&amp;#x2F;docs.docker.com&amp;#x2F;engine&amp;#x2F;swarm&amp;#x2F; Docker Swarm 是 Docker 官方项目之一，提供 Docker 容器集群服务，是 Docker 官方对容器云生态进行支持的核心方案。使用它，用户可以将多个 Docker 主机封装为单个大型的虚拟 Docker 主机，快速打造一套容器云平台。"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://blog.buubiu.com/img/article/MVlZHV1616170137563.png"><meta property="og:image" content="https://blog.buubiu.com/img/article/wkLUG61616170678158.png"><meta property="og:image" content="https://blog.buubiu.com/img/article/ONIifz1616862473458.png"><meta property="article:published_time" content="2021-03-19T16:24:38.000Z"><meta property="article:modified_time" content="2024-01-25T15:08:04.799Z"><meta property="article:author" content="buubiu"><meta property="article:tag" content="Docker"><meta property="twitter:card" content="summary"><meta property="twitter:image:src" content="https://blog.buubiu.com/img/article/MVlZHV1616170137563.png"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://blog.buubiu.com/Docker-Swarm%E4%BD%BF%E7%94%A8/"},"headline":"Docker Swarm使用","image":["https://blog.buubiu.com/img/article/MVlZHV1616170137563.png","https://blog.buubiu.com/img/article/wkLUG61616170678158.png","https://blog.buubiu.com/img/article/ONIifz1616862473458.png"],"datePublished":"2021-03-19T16:24:38.000Z","dateModified":"2024-01-25T15:08:04.799Z","author":{"@type":"Person","name":"buubiu"},"publisher":{"@type":"Organization","name":"buubiu's技术分享主页","logo":{"@type":"ImageObject","url":"https://blog.buubiu.com/img/common/favicon.ico"}},"description":"简介官方：https:&#x2F;&#x2F;docs.docker.com&#x2F;engine&#x2F;swarm&#x2F; Docker Swarm 是 Docker 官方项目之一，提供 Docker 容器集群服务，是 Docker 官方对容器云生态进行支持的核心方案。使用它，用户可以将多个 Docker 主机封装为单个大型的虚拟 Docker 主机，快速打造一套容器云平台。"}</script><link rel="canonical" href="https://blog.buubiu.com/Docker-Swarm%E4%BD%BF%E7%94%A8/"><link rel="icon" href="/img/common/favicon.ico"><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/font-awesome/6.0.0/css/all.min.css"><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/highlight.js/11.7.0/styles/atom-one-light.min.css"><link rel="stylesheet" href="https://fonts.loli.net/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link rel="stylesheet" href="/css/default.css"><!--!--><script>var _hmt = _hmt || [];
        (function() {
            var hm = document.createElement("script");
            hm.src = "//hm.baidu.com/hm.js?3c3ec636275df73c9383cb68964ee62a";
            var s = document.getElementsByTagName("script")[0];
            s.parentNode.insertBefore(hm, s);
        })();</script><!--!--><script src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" defer></script><!--!--><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/cookieconsent/3.1.1/cookieconsent.min.css"><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/lightgallery/1.10.0/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/justifiedGallery/3.8.1/css/justifiedGallery.min.css"><!--!--><!--!--><!--!--><style>.pace{-webkit-pointer-events:none;pointer-events:none;-webkit-user-select:none;-moz-user-select:none;user-select:none}.pace-inactive{display:none}.pace .pace-progress{background:#3273dc;position:fixed;z-index:2000;top:0;right:100%;width:100%;height:2px}</style><script src="https://cdnjs.loli.net/ajax/libs/pace/1.2.4/pace.min.js"></script><!--!--><!--!--><!-- hexo injector head_end start --><script>
  (function () {
      function switchTab() {
          if (!location.hash) {
            return;
          }

          const id = '#' + CSS.escape(location.hash.substring(1));
          const $tabMenu = document.querySelector(`.tabs a[href="${id}"]`);
          if (!$tabMenu) {
            return;
          }

          const $tabMenuContainer = $tabMenu.parentElement.parentElement;
          Array.from($tabMenuContainer.children).forEach($menu => $menu.classList.remove('is-active'));
          Array.from($tabMenuContainer.querySelectorAll('a'))
              .map($menu => document.getElementById($menu.getAttribute("href").substring(1)))
              .forEach($content => $content.classList.add('is-hidden'));

          if ($tabMenu) {
              $tabMenu.parentElement.classList.add('is-active');
          }
          const $activeTab = document.querySelector(id);
          if ($activeTab) {
              $activeTab.classList.remove('is-hidden');
          }
      }
      switchTab();
      window.addEventListener('hashchange', switchTab, false);
  })();
  </script><!-- hexo injector head_end end --><meta name="generator" content="Hexo 6.3.0"></head><body class="is-2-column"><nav class="navbar navbar-main"><div class="container navbar-container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/"><img src="/img/common/favicon.ico" alt="buubiu&#039;s技术分享主页" height="28"></a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">Home</a><a class="navbar-item" href="/archives">Archives</a><a class="navbar-item" href="/categories">Categories</a><a class="navbar-item" href="/tags">Tags</a><a class="navbar-item" href="/about">About</a></div><div class="navbar-end"><a class="navbar-item" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/bufx"><i class="fab fa-github"></i></a><a class="navbar-item is-hidden-tablet catalogue" title="目录" href="javascript:;"><i class="fas fa-list-ul"></i></a><a class="navbar-item search" title="搜索" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-8-widescreen"><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2021-03-19T16:24:38.000Z" title="2021/3/20 00:24:38">2021-03-20</time>发表</span><span class="level-item"><time dateTime="2024-01-25T15:08:04.799Z" title="2024/1/25 23:08:04">2024-01-25</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/Docker/">Docker</a></span><span class="level-item">29 分钟读完 (大约4386个字)</span><span class="level-item" id="busuanzi_container_page_pv"><span id="busuanzi_value_page_pv">0</span>次访问</span></div></div><h1 class="title is-3 is-size-4-mobile">Docker Swarm使用</h1><div class="content"><h3 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h3><p>官方：<a target="_blank" rel="noopener" href="https://docs.docker.com/engine/swarm/">https://docs.docker.com/engine/swarm/</a></p>
<p>Docker Swarm 是 Docker 官方项目之一，提供 Docker 容器集群服务，是 Docker 官方对容器云生态进行支持的核心方案。使用它，用户可以将多个 Docker 主机封装为单个大型的虚拟 Docker 主机，快速打造一套容器云平台。</p>
<span id="more"></span>

<p>Docker 1.12 Swarm mode 已经内嵌入 Docker 引擎，成为了 docker 子命令 <code>docker swarm</code>。请注意与旧的 <code>Docker Swarm</code> 区分开来。</p>
<p><code>Swarm mode</code> 内置 kv 存储功能，提供了众多的新特性，比如：具有容错能力的去中心化设计、内置服务发现、负载均衡、路由网格、动态伸缩、滚动更新、安全传输等。使得 Docker 原生的 <code>Swarm</code> 集群具备与 Mesos、Kubernetes 竞争的实力。</p>
<h3 id="相关概念"><a href="#相关概念" class="headerlink" title="相关概念"></a>相关概念</h3><p>Swarm 是使用 SwarmKit 构建的 Docker 引擎内置（原生）的集群管理和编排工具。使用 Swarm 集群之前需要了解以下几个概念。</p>
<h4 id="节点"><a href="#节点" class="headerlink" title="节点"></a>节点</h4><p>运行Docker的主机可以主动初始化一个<code>Swarm</code>集群或者加入一个已经存在的<code>Swarm</code>集群，这样这个运行Docker的主机就成为了一个<code>Swarm</code>集群的节点（<code>node</code>）。</p>
<p>节点分为管理 (<code>manager</code>) 节点和工作 (<code>worker</code>) 节点。</p>
<h5 id="管理节点"><a href="#管理节点" class="headerlink" title="管理节点"></a>管理节点</h5><p>管理节点用于 <code>Swarm</code> 集群的管理，<code>docker swarm</code> 命令基本只能在管理节点执行（节点退出集群命令 <code>docker swarm leave</code> 可以在工作节点执行）。一个 <code>Swarm</code> 集群可以有多个管理节点，但只有一个管理节点可以成为 <code>leader</code>，<code>leader</code> 通过 <code>raft</code> 协议实现。</p>
<blockquote>
<p><strong>raft：</strong>就是保证集群中一半以上的机器正常才算集群有效，这就是为什么大部分集群的机器都是奇数台，假如有四台机器，其中两台挂了，则集群也就失效了，这和总共有三台机器的效果一样，所以为了保证资源充分利用，集群的机器数为奇数台。</p>
</blockquote>
<h5 id="工作节点"><a href="#工作节点" class="headerlink" title="工作节点"></a>工作节点</h5><p>工作节点是任务执行节点，管理节点将服务 (<code>service</code>) 下发至工作节点执行。管理节点默认也作为工作节点。你也可以通过配置让服务只运行在管理节点。</p>
<p>来自 Docker 官网的这张图片形象的展示了集群中管理节点与工作节点的关系。</p>
<p><img src="/../img/article/MVlZHV1616170137563.png"></p>
<h4 id="服务和任务"><a href="#服务和任务" class="headerlink" title="服务和任务"></a>服务和任务</h4><p>任务 （<code>Task</code>）是 <code>Swarm</code> 中的最小的调度单位，目前来说就是一个单一的容器。</p>
<p>服务 （<code>Services</code>） 是指一组任务的集合，服务定义了任务的属性。服务有两种模式：</p>
<ul>
<li><code>replicated services</code> 按照一定规则在各个工作节点上运行指定个数的任务。</li>
<li><code>global services</code> 每个工作节点上运行一个任务</li>
</ul>
<p>两种模式通过 <code>docker service create</code> 的 <code>--mode</code> 参数指定。</p>
<p>来自 Docker 官网的这张图片形象的展示了容器、任务、服务的关系。</p>
<p><img src="/../img/article/wkLUG61616170678158.png"></p>
<h3 id="创建Swarm集群"><a href="#创建Swarm集群" class="headerlink" title="创建Swarm集群"></a>创建Swarm集群</h3><p>我们来创建一个包含一个管理节点和两个工作节点的最小 <code>Swarm</code> 集群。</p>
<h4 id="初始化集群"><a href="#初始化集群" class="headerlink" title="初始化集群"></a>初始化集群</h4><p>在 <code>Docker Machine</code> 一节中我们了解到 <code>Docker Machine</code> 可以在数秒内创建一个虚拟的 Docker 主机，下面我们使用它来创建三个 Docker 主机，并加入到集群中。</p>
<ol>
<li>我们首先创建一个 Docker 主机作为管理节点。</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">docker-machine create -d virtualbox manager</span></span><br></pre></td></tr></table></figure>

<ol start="2">
<li>SSH到manager机器上执行命令</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">docker-machine ssh manager</span></span><br></pre></td></tr></table></figure>

<ol start="3">
<li><p>我们使用<code>docker swarm init</code>在管理节点初始化一个<code>Swarm</code>集群</p>
<ul>
<li><p>如果你的 Docker 主机有多个网卡，拥有多个 IP，必须使用 <code>--advertise-addr</code> 指定 IP，否会提示报错</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker@manager:~$ docker swarm init</span><br><span class="line">Error response from daemon: could not choose an IP address to advertise since this system has multiple addresses on different interfaces (10.0.2.15 on eth0 and 192.168.99.101 on eth1) - specify one with --advertise-addr</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li><ul>
<li>执行 <code>docker swarm init</code> 命令的节点自动成为管理节点。</li>
</ul>
</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">docker@manager:~$ docker swarm init --advertise-addr 192.168.99.101</span><br><span class="line">Swarm initialized: current node (ss6edkoczov6ha2xkl7muqm4a) is now a manager.</span><br><span class="line"></span><br><span class="line">To add a worker to this swarm, run the following command:</span><br><span class="line"></span><br><span class="line">    docker swarm join --token SWMTKN-1-4iwiay7mou608578t0xiluv381i2k0y3uuu1t0sfabowww84qr-54x2xsupnmlr18ealfgp8uaqk 192.168.99.101:2377</span><br><span class="line"></span><br><span class="line">To add a manager to this swarm, run &#x27;docker swarm join-token manager&#x27; and follow the instructions.</span><br></pre></td></tr></table></figure>

<h4 id="增加工作节点"><a href="#增加工作节点" class="headerlink" title="增加工作节点"></a>增加工作节点</h4><p>创建两个 Docker 主机作为工作节点，并加入到集群中</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">docker-machine create -d virtualbox worker1</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">docker-machine ssh worker1</span></span><br><span class="line">   ( &#x27;&gt;&#x27;)</span><br><span class="line">  /) TC (\   Core is distributed with ABSOLUTELY NO WARRANTY.</span><br><span class="line"> (/-_--_-\)           www.tinycorelinux.net</span><br><span class="line"></span><br><span class="line">docker@worker1:~$ docker swarm join --token SWMTKN-1-4iwiay7mou608578t0xiluv381i2k0y3uuu1t0sfabowww84qr-54x2xsupnmlr18ealfgp8uaqk 192.168.99.101:2377</span><br><span class="line"></span><br><span class="line">This node joined a swarm as a worker.</span><br></pre></td></tr></table></figure>



<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">docker-machine create -d virtualbox worker2</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">docker-machine ssh worker2</span></span><br><span class="line">   ( &#x27;&gt;&#x27;)</span><br><span class="line">  /) TC (\   Core is distributed with ABSOLUTELY NO WARRANTY.</span><br><span class="line"> (/-_--_-\)           www.tinycorelinux.net</span><br><span class="line"></span><br><span class="line">docker@worker1:~$ docker swarm join --token SWMTKN-1-4iwiay7mou608578t0xiluv381i2k0y3uuu1t0sfabowww84qr-54x2xsupnmlr18ealfgp8uaqk 192.168.99.101:2377</span><br><span class="line"></span><br><span class="line">This node joined a swarm as a worker.</span><br></pre></td></tr></table></figure>

<h4 id="查看所有节点的IP"><a href="#查看所有节点的IP" class="headerlink" title="查看所有节点的IP"></a>查看所有节点的IP</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">docker-machine ls</span><br><span class="line">NAME      ACTIVE   DRIVER       STATE     URL                         SWARM   DOCKER      ERRORS</span><br><span class="line">manager   -        virtualbox   Running   tcp://192.168.99.110:2376           v19.03.12</span><br><span class="line">worker1   -        virtualbox   Running   tcp://192.168.99.111:2376           v19.03.12</span><br></pre></td></tr></table></figure>



<h4 id="查看集群"><a href="#查看集群" class="headerlink" title="查看集群"></a>查看集群</h4><h5 id="docker-node-ls"><a href="#docker-node-ls" class="headerlink" title="docker node ls"></a>docker node ls</h5><p>在管理节点使用 <code>docker node ls</code> 查看集群列表</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">docker@manager:~$ docker node ls</span><br><span class="line">ID                            HOSTNAME            STATUS              AVAILABILITY        MANAGER STATUS      ENGINE VERSION</span><br><span class="line">hztlhn18uasmj981k6q5k32sa *   manager             Ready               Active              Leader              19.03.12</span><br><span class="line">t7ats765xa9bmq2xeyytlroj1     worker1             Ready               Active                                  19.03.12</span><br><span class="line">s1yb705h1ebur8ojxttu9ikr1     worker2             Ready               Active                                  19.03.12</span><br></pre></td></tr></table></figure>

<h3 id="部署服务"><a href="#部署服务" class="headerlink" title="部署服务"></a>部署服务</h3><p>我们使用<code>docker service</code>命令来管理 <code>Swarm</code> 集群中的服务，该命令只能在管理节点运行。</p>
<p><strong>注意，最好每个节点都把镜像源替换为阿里云，否则下载很慢。</strong></p>
<h4 id="新建服务"><a href="#新建服务" class="headerlink" title="新建服务"></a>新建服务</h4><h5 id="docker-service"><a href="#docker-service" class="headerlink" title="docker service"></a>docker service</h5><p>现在我们在managerj节点创建的 <code>Swarm</code> 集群中运行一个名为 <code>tomcat</code> 服务。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">--replicas 3 启用 3 个副本</span></span><br><span class="line">docker@manager:~$ docker service create --replicas 3 -p 8080:8080 --name tomcat tomcat:8.0-jre8</span><br></pre></td></tr></table></figure>

<p>现在我们使用浏览器，输入任意节点 IP:8080 ，即可看到 tomcat 默认页面。</p>
<h4 id="查看服务"><a href="#查看服务" class="headerlink" title="查看服务"></a>查看服务</h4><h5 id="docker-service-ls"><a href="#docker-service-ls" class="headerlink" title="docker service ls"></a>docker service ls</h5><p>使用 <code>docker service ls</code> 来查看当前 <code>Swarm</code> 集群运行的服务</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">docker@manager:~$ docker service ls</span><br><span class="line">ID                  NAME                MODE                REPLICAS            IMAGE               PORTS</span><br><span class="line">gb68wnbd9g46        tomcat              replicated          3/3                 tomcat:8.0-jre8     *:8080-&gt;8080/tcp</span><br></pre></td></tr></table></figure>

<h5 id="docker-service-ps"><a href="#docker-service-ps" class="headerlink" title="docker service ps"></a>docker service ps</h5><p>使用 <code>docker service ps</code> 来查看某个服务的详情</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">docker@manager:~$ docker service ps tomcat</span><br><span class="line">ID                  NAME                IMAGE               NODE                DESIRED STATE       CURRENT STATE             ERROR               PORTS</span><br><span class="line">nuvede7hmggu        tomcat.1            tomcat:8.0-jre8     worker2             Running             Preparing 3 minutes ago</span><br><span class="line">w5psn6cpr16m        tomcat.2            tomcat:8.0-jre8     manager             Running             Preparing 3 minutes ago</span><br><span class="line">pshili013nya        tomcat.3            tomcat:8.0-jre8     worker1             Running             Preparing 3 minutes ago</span><br></pre></td></tr></table></figure>

<h5 id="docker-service-logs"><a href="#docker-service-logs" class="headerlink" title="docker service logs"></a>docker service logs</h5><p>使用 <code>docker service logs</code> 来查看某个服务的日志</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">docker@manager:~$ docker service logs tomcat</span><br><span class="line">docker@manager:~$ docker service logs tomcat</span><br><span class="line">tomcat.1.8v0xggulqhx0@manager    | 27-Mar-2021 16:22:26.051 INFO [main] org.apache.catalina.startup.VersionLoggerListener.log Server version:        Apache Tomcat/8.0.53</span><br><span class="line">...</span><br><span class="line">tomcat.1.8v0xggulqhx0@manager    | 27-Mar-2021 16:22:28.449 INFO [main] org.apache.coyote.AbstractProtocol.start Starting ProtocolHandler [&quot;http-apr-8080&quot;]</span><br><span class="line">tomcat.1.8v0xggulqhx0@manager    | 27-Mar-2021 16:22:28.466 INFO [main] org.apache.coyote.AbstractProtocol.start Starting ProtocolHandler [&quot;ajp-apr-8009&quot;]</span><br><span class="line">tomcat.1.8v0xggulqhx0@manager    | 27-Mar-2021 16:22:28.472 INFO [main] org.apache.catalina.startup.Catalina.start Server startup in 2133 ms</span><br><span class="line">tomcat.2.f566j6imruvq@worker1    | 27-Mar-2021 16:22:51.954 INFO [main] org.apache.catalina.startup.VersionLoggerListener.log Server version:        Apache Tomcat/8.0.53</span><br><span class="line">tomcat.2.f566j6imruvq@worker1    | 27-Mar-2021 16:22:51.958 INFO [main] org.apache.catalina.startup.VersionLoggerListener.log Server built:          Jun 29 2018 14:42:45 UTC</span><br><span class="line">.....</span><br><span class="line">tomcat.2.f566j6imruvq@worker1    | 27-Mar-2021 16:22:53.753 INFO [main] org.apache.coyote.AbstractProtocol.start Starting ProtocolHandler [&quot;http-apr-8080&quot;]</span><br><span class="line">tomcat.2.f566j6imruvq@worker1    | 27-Mar-2021 16:22:53.787 INFO [main] org.apache.coyote.AbstractProtocol.start Starting ProtocolHandler [&quot;ajp-apr-8009&quot;]</span><br><span class="line">tomcat.2.f566j6imruvq@worker1    | 27-Mar-2021 16:22:53.810 INFO [main] org.apache.catalina.startup.Catalina.start Server startup in 1624 ms</span><br></pre></td></tr></table></figure>

<h4 id="访问页面"><a href="#访问页面" class="headerlink" title="访问页面"></a>访问页面</h4><p>随便打开一个ip:8080都可以</p>
<p><a target="_blank" rel="noopener" href="http://192.168.99.111:8080/">http://192.168.99.111:8080/</a></p>
<p><img src="/../img/article/ONIifz1616862473458.png"></p>
<h4 id="服务伸缩"><a href="#服务伸缩" class="headerlink" title="服务伸缩"></a>服务伸缩</h4><h5 id="docker-service-scale"><a href="#docker-service-scale" class="headerlink" title="docker service scale"></a>docker service scale</h5><p>我们可以使用 <code>docker service scale</code> 对一个服务运行的容器数量进行伸缩。</p>
<ul>
<li>当业务处于高峰期时，我们需要扩展服务运行的容器数量。</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">docker@manager:~$ docker service scale tomcat=5</span><br><span class="line">tomcat scaled to 5</span><br><span class="line">overall progress: 5 out of 5 tasks</span><br><span class="line">1/5: running   [==================================================&gt;]</span><br><span class="line">2/5: running   [==================================================&gt;]</span><br><span class="line">3/5: running   [==================================================&gt;]</span><br><span class="line">4/5: running   [==================================================&gt;]</span><br><span class="line">5/5: running   [==================================================&gt;]</span><br><span class="line">verify: Service converged</span><br></pre></td></tr></table></figure>

<ul>
<li>当业务平稳时，我们需要减少服务运行的容器数量。</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">docker@manager:~$ docker service scale tomcat=2</span><br><span class="line">tomcat scaled to 2</span><br><span class="line">overall progress: 2 out of 2 tasks</span><br><span class="line">1/2: running   [==================================================&gt;]</span><br><span class="line">2/2: running   [==================================================&gt;]</span><br><span class="line">verify: Service converged</span><br></pre></td></tr></table></figure>

<h4 id="删除服务"><a href="#删除服务" class="headerlink" title="删除服务"></a>删除服务</h4><h5 id="docker-service-rm"><a href="#docker-service-rm" class="headerlink" title="docker service rm"></a>docker service rm</h5><p>使用 <code>docker service rm</code> 来从 <code>Swarm</code> 集群移除某个服务。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker@manager:~$ docker service rm tomcat</span><br></pre></td></tr></table></figure>

<h3 id="使用-docker-compose文件"><a href="#使用-docker-compose文件" class="headerlink" title="使用 docker compose文件"></a>使用 docker compose文件</h3><p>在 <code>Swarm</code> 集群中也可以使用 <code>compose</code> 文件 （<code>docker-compose.yml</code>） 来配置、启动多个服务。</p>
<p>我们使用 <code>docker service create</code> 一次只能部署一个服务，使用 <code>docker-compose.yml</code> 我们可以一次启动多个关联的服务。</p>
<p>我们使用 <code>docker stack deploy</code> 而不是 <code>docker service create</code>，Stack 会帮我们管理这些对象。</p>
<p>我们可以直接用 <code>docker-compose.yml</code> 文件，但是不能 <code>build</code> 镜像，Swarm 只接收构建好的镜像，新加了一个 <code>deploy</code> 字段。当使用 <code>docker-compose</code> 执行这个文件时，会忽略 <code>deploy</code> 字段。<code>docker stack</code> 中会忽略 <code>build</code> 字段，所以我们可以开发和发布都使用一个 <code>docker-compose.yml</code> 文件。</p>
<h4 id="创建docker-compose-yml文件"><a href="#创建docker-compose-yml文件" class="headerlink" title="创建docker-compose.yml文件"></a>创建docker-compose.yml文件</h4><ol>
<li><p>在一个空目录中创建一个docker-compose.yml文件</p>
</li>
<li><p>在配置文件中定义一个项目存在哪些服务</p>
<p>相对于之前新加了一个 <code>deploy</code> 字段。</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">version: <span class="string">&quot;3.0&quot;</span> <span class="comment">#定义版本，官方要求，最高为4.0</span></span><br><span class="line">services: <span class="comment">#所有的服务</span></span><br><span class="line">  tomcat: <span class="comment">#服务名，唯一</span></span><br><span class="line">    image: tomcat:<span class="number">8.0</span>-jre8 <span class="comment">#创建当前这个服务使用哪个镜像</span></span><br><span class="line">    ports: <span class="comment">#映射端口，是个数组</span></span><br><span class="line">      - <span class="number">8080</span>:<span class="number">8080</span></span><br><span class="line">    networks: <span class="comment">#指定自定义网络</span></span><br><span class="line">      - overlay</span><br><span class="line">    deploy: <span class="comment"># 部署</span></span><br><span class="line">      mode: replicated <span class="comment"># 复制模式</span></span><br><span class="line">      replicas: <span class="number">3</span> <span class="comment">#启动多少个容器</span></span><br><span class="line">      <span class="comment">#update_config: # 更新规则</span></span><br><span class="line">        <span class="comment">#parallelism: 2 # 一次两个</span></span><br><span class="line">        <span class="comment">#delay: 10s # 更新延迟 10s，给 app 一个启动时间</span></span><br><span class="line">      <span class="comment">#restart_policy: # 重启规则</span></span><br><span class="line">        <span class="comment">#condition: on-failure #遇到失败就重启</span></span><br><span class="line">      <span class="comment">#placement:</span></span><br><span class="line">        <span class="comment">#constraints: [node.role == manager] # 只部署在 manager 节点</span></span><br><span class="line">networks:</span><br><span class="line">  overlay:</span><br></pre></td></tr></table></figure></li>
</ol>
<h4 id="运行docker-compose部署服务"><a href="#运行docker-compose部署服务" class="headerlink" title="运行docker-compose部署服务"></a>运行docker-compose部署服务</h4><p>部署服务使用 <code>docker stack deploy</code>，其中 <code>-c</code> 参数指定 compose 文件名</p>
<p>命令：<code>docker stack deploy -c docker-compose.yml tomcat</code></p>
<ul>
<li>-c 指定配置文件 </li>
<li>deploy 也可以换成 up</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">docker@manager:~$ docker stack deploy -c docker-compose.yml tomcat</span><br><span class="line">Creating network tomcat_overlay</span><br><span class="line">Creating service tomcat_tomcat</span><br></pre></td></tr></table></figure>

<h4 id="查看compose服务"><a href="#查看compose服务" class="headerlink" title="查看compose服务"></a>查看compose服务</h4><p>命令：<code>docker stack ls</code></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">docker@manager:~$ docker stack ls</span><br><span class="line">NAME                SERVICES            ORCHESTRATOR</span><br><span class="line">tomcat              1                   Swarm</span><br></pre></td></tr></table></figure>

<h4 id="查看compose容器"><a href="#查看compose容器" class="headerlink" title="查看compose容器"></a>查看compose容器</h4><p>命令：<code>docker stack ps tomcat</code></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">docker@manager:~$ docker stack ps tomcat</span><br><span class="line">ID                  NAME                IMAGE               NODE                DESIRED STATE       CURRENT STATE                ERROR               PORTS</span><br><span class="line">kn4sesyafad3        tomcat_tomcat.1     tomcat:8.0-jre8     manager             Running             Running about a minute ago</span><br><span class="line">yiqfmly0simi        tomcat_tomcat.2     tomcat:8.0-jre8     manager             Running             Running about a minute ago</span><br><span class="line">v9ygrv2al221        tomcat_tomcat.3     tomcat:8.0-jre8     worker1             Running             Running about a minute ago</span><br></pre></td></tr></table></figure>

<h4 id="移除服务"><a href="#移除服务" class="headerlink" title="移除服务"></a>移除服务</h4><p>命令：<code>docker stack rm tomcat</code></p>
<p>该命令不会移除服务所使用的 <code>数据卷</code>，如果你想移除数据卷请使用 <code>docker volume rm</code></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">docker@manager:~$ docker stack rm tomcat</span><br><span class="line">Removing service tomcat_tomcat</span><br><span class="line">Removing network tomcat_overlay</span><br></pre></td></tr></table></figure>

<h4 id="更新服务"><a href="#更新服务" class="headerlink" title="更新服务"></a>更新服务</h4><p>如果我们更新这个配置文件，可以重新执行docker-compose.yml文件即可。</p>
<h3 id="管理密钥"><a href="#管理密钥" class="headerlink" title="管理密钥"></a>管理密钥</h3><p>在动态的、大规模的分布式集群上，管理和分发 <code>密码</code>、<code>证书</code> 等敏感信息是极其重要的工作。传统的密钥分发方式（如密钥放入镜像中，设置环境变量，volume 动态挂载等）都存在着潜在的巨大的安全风险。</p>
<p>Docker 目前已经提供了 <code>secrets</code> 管理功能，用户可以在 Swarm 集群中安全地管理密码、密钥证书等敏感数据，并允许在多个 Docker 容器实例之间共享访问指定的敏感数据。它最大支持 500KB 的字符串或二进制内容。</p>
<p><code>Secret</code> 会被加密的保存在管理节点的硬盘上，被加密传输。只有被允许的容器才能查看 <code>Secret</code>，在容器中它只会被存在内存中，可以在 <code>/run/secrets/&lt;secret_name | secret_alias&gt;</code> 访问到。</p>
<blockquote>
<p>注意： <code>secret</code> 也可以在 <code>Docker Compose</code> 中使用。</p>
</blockquote>
<p>我们可以用 <code>docker secret</code> 命令来管理敏感信息。</p>
<h4 id="创建secret"><a href="#创建secret" class="headerlink" title="创建secret"></a>创建secret</h4><p>我们使用 <code>docker secret create</code> 命令创建 <code>secret</code>。</p>
<p><code>Secret</code> 可以通过两种方式创建，一种是文件另一种是 <code>stdin(管道符｜)</code> 创建。</p>
<h5 id="文件创建"><a href="#文件创建" class="headerlink" title="文件创建"></a>文件创建</h5><ol>
<li><p>先创建文件，并填写需要加密的内容</p>
</li>
<li><p>执行创建命令</p>
<p>命令格式：<code>docker secret create [KEY] [FILENAME]</code></p>
</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">docker@manager:~$ cat mysql_root_password.txt</span><br><span class="line">123456</span><br><span class="line">docker@manager:~$ docker secret create mysql_root_password mysql_root_password.txt</span><br><span class="line">lvn3k6ajcytuno476mferezr5</span><br><span class="line">docker@manager:~$</span><br></pre></td></tr></table></figure>

<h5 id="管道符形式创建"><a href="#管道符形式创建" class="headerlink" title="管道符形式创建"></a>管道符形式创建</h5><p>​	命令格式：<code>[可以生成字符串的命令] | docker secret create [KEY]</code></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">docker@manager:~$ echo &#x27;123456&#x27; | docker secret create mysql_password -</span><br><span class="line">p94kxcvqfmkwdg55om2i8fmbe</span><br><span class="line">docker@manager:~$</span><br></pre></td></tr></table></figure>

<h4 id="查看secret"><a href="#查看secret" class="headerlink" title="查看secret"></a>查看secret</h4><p>命令格式：使用 <code>docker secret ls</code> </p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">docker@manager:~$ docker secret ls</span><br><span class="line">ID                          NAME                DRIVER              CREATED             UPDATED</span><br><span class="line">p94kxcvqfmkwdg55om2i8fmbe   mysql_password                            21 seconds ago      21 seconds ago</span><br><span class="line">lvn3k6ajcytuno476mferezr5   mysql_root_password                       30 seconds ago      30 seconds ago</span><br><span class="line">docker@manager:~$</span><br></pre></td></tr></table></figure>

<h4 id="使用secret创建服务"><a href="#使用secret创建服务" class="headerlink" title="使用secret创建服务"></a>使用secret创建服务</h4><p>如果你没有在 <code>target</code> 中显式的指定路径时，<code>secret</code> 默认通过 <code>tmpfs</code> 文件系统挂载到容器的 <code>/run/secrets</code> 目录中。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">docker@manager:~$ docker service create \</span><br><span class="line">     --name mysql \</span><br><span class="line">     --replicas 2 \</span><br><span class="line">     --secret source=mysql_root_password,target=mysql_root_password \</span><br><span class="line">     --secret source=mysql_password,target=mysql_password \</span><br><span class="line">     -e MYSQL_ROOT_PASSWORD_FILE=&quot;/run/secrets/mysql_root_password&quot; \</span><br><span class="line">     -e MYSQL_PASSWORD_FILE=&quot;/run/secrets/mysql_password&quot; \</span><br><span class="line">     -e MYSQL_USER=&quot;buubiu&quot; \</span><br><span class="line">     -e MYSQL_DATABASE=&quot;buubiu&quot; \</span><br><span class="line">     mysql:latest</span><br><span class="line"></span><br><span class="line">overall progress: 2 out of 2 tasks</span><br><span class="line">1/2: running   [==================================================&gt;]</span><br><span class="line">2/2: running   [==================================================&gt;]</span><br><span class="line">verify: Service converged</span><br><span class="line">docker@manager:~$</span><br></pre></td></tr></table></figure>

<p><strong>–secret</strong><code>用来指定 Service 能使用那个</code>secret&#96;</p>
<h4 id="查看通过secret创建的服务"><a href="#查看通过secret创建的服务" class="headerlink" title="查看通过secret创建的服务"></a>查看通过secret创建的服务</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">docker@manager:~$ docker service ls</span><br><span class="line">ID                  NAME                MODE                REPLICAS            IMAGE               PORTS</span><br><span class="line">mai1e55esrrs        mysql               replicated          2/2                 mysql:latest</span><br><span class="line">docker@manager:~$</span><br></pre></td></tr></table></figure>

<h4 id="删除服务的secret"><a href="#删除服务的secret" class="headerlink" title="删除服务的secret"></a>删除服务的secret</h4><ul>
<li>单纯的删除secret，命令：<code>docker secret rm [KEY][KEY]...</code></li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">docker@manager:~$ docker secret rm my_password</span><br><span class="line">my_password</span><br><span class="line">docker@manager:~$</span><br></pre></td></tr></table></figure>

<ul>
<li><p>如果我们现在删除 Service 的 <code>secret</code>，可以使用 <code>--secret-rm</code></p>
<blockquote>
<p>注意：删除 Service 的 secret，容器会自动重建，因为 Service 是容器的一部分。</p>
</blockquote>
</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker@manager:~$ docker service update --secret-rm mysql_user</span><br></pre></td></tr></table></figure>

<p>通过以上方法，我们没有像以前通过设置环境变量来设置 MySQL 密码， 而是采用 <code>docker secret</code> 来设置密码，防范了密码泄露的风险。</p>
<h3 id="管理配置信息"><a href="#管理配置信息" class="headerlink" title="管理配置信息"></a>管理配置信息</h3><p>在动态的、大规模的分布式集群上，管理和分发配置文件也是很重要的工作。传统的配置文件分发方式（如配置文件放入镜像中，设置环境变量，volume 动态挂载等）都降低了镜像的通用性。</p>
<p>在 Docker 17.06 以上版本中，Docker 新增了 <code>docker config</code> 子命令来管理集群中的配置信息，以后你无需将配置文件放入镜像或挂载到容器中就可实现对服务的配置。</p>
<blockquote>
<p>注意：<code>config</code> 仅能在 Swarm 集群中使用。</p>
</blockquote>
<p>这里我们以在 Swarm 集群中部署 <code>redis</code> 服务为例。</p>
<h4 id="创建config"><a href="#创建config" class="headerlink" title="创建config"></a>创建config</h4><p>命令格式：<code>docker config create [NAME] [FILE]</code></p>
<ol>
<li>新建 <code>redis.conf</code> 文件</li>
</ol>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">port 6380</span><br></pre></td></tr></table></figure>

<p>此项配置 Redis 监听 <code>6380</code> 端口</p>
<ol start="2">
<li>创建config</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">docker@manager:~$ docker config create redis.conf redis.conf</span><br><span class="line">iqxk8sghv1vtj2kzkc2bwgp1e</span><br><span class="line">docker@manager:~$</span><br></pre></td></tr></table></figure>

<h4 id="查看config"><a href="#查看config" class="headerlink" title="查看config"></a>查看config</h4><p>命令格式：<code>docker config ls</code></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">docker@manager:~$ docker config ls</span><br><span class="line">ID                          NAME                CREATED             UPDATED</span><br><span class="line">iqxk8sghv1vtj2kzkc2bwgp1e   redis.conf          52 seconds ago      52 seconds ago</span><br></pre></td></tr></table></figure>

<h4 id="使用config"><a href="#使用config" class="headerlink" title="使用config"></a>使用config</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">docker@manager:~$ docker service create \</span><br><span class="line">     --name redis \</span><br><span class="line">     # --config source=redis.conf,target=/etc/redis.conf \</span><br><span class="line">     --config redis.conf \</span><br><span class="line">     -p 6380:6380 \</span><br><span class="line">     redis:latest \</span><br><span class="line">     redis-server /redis.conf</span><br></pre></td></tr></table></figure>

<p>如果你没有在 <code>target</code> 中显式的指定路径时，默认的 <code>redis.conf</code> 以 <code>tmpfs</code> 文件系统挂载到容器的 <code>/config.conf</code>。</p>
<p>经过测试，redis 可以正常使用。</p>
<p>以前我们通过监听主机目录来配置 Redis，就需要在集群的每个节点放置该文件，如果采用 <code>docker config</code> 来管理服务的配置信息，我们只需在集群中的管理节点创建 <code>config</code>，当部署服务时，集群会自动的将配置文件分发到运行服务的各个节点中，大大降低了配置信息的管理和分发难度。</p>
<h3 id="滚动升级"><a href="#滚动升级" class="headerlink" title="滚动升级"></a>滚动升级</h3><p>滚动升级是一次只升级一部分副本，不一次性全部升级，它降低了应用更新的风险，如果某个副本更新失败，整个更新将暂停，其他副本则可以继续提供服务。在更新的过程中，总是有副本在运行的，也保证了业务的连续性。</p>
<p>现在我们把 <code>nginx:1.16</code> 版本升级到 <code>nginx:1.17</code>。</p>
<h4 id="创建服务"><a href="#创建服务" class="headerlink" title="创建服务"></a>创建服务</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">docker@manager:~$ docker service create --name nginx --replicas=3 nginx:1.16</span><br><span class="line">jzxnmnhw2lif7uklj8cp6d4qw</span><br><span class="line">overall progress: 3 out of 3 tasks</span><br><span class="line">1/3: running   [==================================================&gt;]</span><br><span class="line">2/3: running   [==================================================&gt;]</span><br><span class="line">3/3: running   [==================================================&gt;]</span><br><span class="line">verify: Service converged</span><br><span class="line">docker@manager:~$</span><br></pre></td></tr></table></figure>

<h4 id="升级服务版本"><a href="#升级服务版本" class="headerlink" title="升级服务版本"></a>升级服务版本</h4><p>命令格式：<code>docker service update</code></p>
<blockquote>
<p>swarm 会停止一个容器，更新它，如果失败就会暂停整个更新过程</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">docker@manager:~$ docker service update --image nginx:1.17 nginx</span><br><span class="line">nginx</span><br><span class="line">overall progress: 2 out of 3 tasks</span><br><span class="line">1/3: running   [==================================================&gt;]</span><br><span class="line">2/3: running   [==================================================&gt;]</span><br><span class="line">3/3: pending   [================&gt;                                  ]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">docker@manager:~$ docker service ps nginx</span><br><span class="line">ID                  NAME                IMAGE               NODE                DESIRED STATE       CURRENT STATE            ERROR               PORTS</span><br><span class="line">u25clkz1vw5p        nginx.1             nginx:1.17          manager             Running             Running 2 minutes ago</span><br><span class="line">3urf32x2gn39         \_ nginx.1         nginx:1.16          manager             Shutdown            Shutdown 3 minutes ago</span><br><span class="line">210z5dcn3lg2        nginx.2             nginx:1.17          manager             Running             Running 2 minutes ago</span><br><span class="line">zns691zenqd5         \_ nginx.2         nginx:1.16          manager             Shutdown            Shutdown 2 minutes ago</span><br><span class="line">kx7709qb8d6l        nginx.3             nginx:1.17          manager             Running             Running 2 minutes ago</span><br><span class="line">l6s0tyoxqhrs         \_ nginx.3         nginx:1.16          manager             Shutdown            Shutdown 2 minutes ago</span><br><span class="line">docker@manager:~$</span><br></pre></td></tr></table></figure>

<p>以上命令使用 <code>--image</code> 选项更新了服务的镜像。当然我们也可以使用 <code>docker service update</code> 更新任意的配置。</p>
<p><code>--secret-add</code> 选项可以增加一个密钥</p>
<p><code>--secret-rm</code> 选项可以删除一个密钥</p>
<p>更多选项可以通过 <code>docker service update -h</code> 命令查看。</p>
<h4 id="服务回退"><a href="#服务回退" class="headerlink" title="服务回退"></a>服务回退</h4><p>命令格式：<code>docker service update --rollback [NAME]</code> 或者<code>docker serivice rollback [NAME]</code></p>
<blockquote>
<p>注意：只能回滚到上一次执行 <code>docker service update</code> 之前的状态，并不能无限制地回滚。</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">docker@manager:~$ docker service update --rollback nginx</span><br><span class="line">nginx</span><br><span class="line">rollback: manually requested rollback</span><br><span class="line">overall progress: rolling back update: 3 out of 3 tasks</span><br><span class="line">1/3: running   [&gt;                                                  ]</span><br><span class="line">2/3: running   [&gt;                                                  ]</span><br><span class="line">3/3: running   [&gt;                                                  ]</span><br><span class="line">verify: Waiting 5 seconds to verify that tasks are stable...</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">docker@manager:~$ docker service ps nginx</span><br><span class="line">ID                  NAME                IMAGE               NODE                DESIRED STATE       CURRENT STATE             ERROR               PORTS</span><br><span class="line">c8jq0s3ezu0s        nginx.1             nginx:1.16          manager             Running             Running 20 seconds ago</span><br><span class="line">u25clkz1vw5p         \_ nginx.1         nginx:1.17          manager             Shutdown            Shutdown 20 seconds ago</span><br><span class="line">3urf32x2gn39         \_ nginx.1         nginx:1.16          manager             Shutdown            Shutdown 6 minutes ago</span><br><span class="line">9jjghoimxmcv        nginx.2             nginx:1.16          manager             Running             Running 22 seconds ago</span><br><span class="line">210z5dcn3lg2         \_ nginx.2         nginx:1.17          manager             Shutdown            Shutdown 22 seconds ago</span><br><span class="line">zns691zenqd5         \_ nginx.2         nginx:1.16          manager             Shutdown            Shutdown 6 minutes ago</span><br><span class="line">qg7b61je5l9a        nginx.3             nginx:1.16          manager             Running             Running 18 seconds ago</span><br><span class="line">kx7709qb8d6l         \_ nginx.3         nginx:1.17          manager             Shutdown            Shutdown 19 seconds ago</span><br><span class="line">l6s0tyoxqhrs         \_ nginx.3         nginx:1.16          manager             Shutdown            Shutdown 6 minutes ago</span><br><span class="line">docker@manager:~$</span><br></pre></td></tr></table></figure>

</div><div class="article-licensing box"><div class="licensing-title"><p>Docker Swarm使用</p><p><a href="https://blog.buubiu.com/Docker-Swarm使用/">https://blog.buubiu.com/Docker-Swarm使用/</a></p></div><div class="licensing-meta level is-mobile"><div class="level-left"><div class="level-item is-narrow"><div><h6>作者</h6><p>buubiu</p></div></div><div class="level-item is-narrow"><div><h6>发布于</h6><p>2021-03-20</p></div></div><div class="level-item is-narrow"><div><h6>更新于</h6><p>2024-01-25</p></div></div><div class="level-item is-narrow"><div><h6>许可协议</h6><p><a class="icons" rel="noopener" target="_blank" title="Creative Commons" href="https://creativecommons.org/"><i class="icon fab fa-creative-commons"></i></a><a class="icons" rel="noopener" target="_blank" title="Attribution" href="https://creativecommons.org/licenses/by/4.0/"><i class="icon fab fa-creative-commons-by"></i></a><a class="icons" rel="noopener" target="_blank" title="Noncommercial" href="https://creativecommons.org/licenses/by-nc/4.0/"><i class="icon fab fa-creative-commons-nc"></i></a></p></div></div></div></div></div><div class="article-tags is-size-7 mb-4"><span class="mr-2">#</span><a class="link-muted mr-2" rel="tag" href="/tags/Docker/">Docker</a></div><!--!--></article></div><!--!--><nav class="post-navigation mt-4 level is-mobile"><div class="level-start"><a class="article-nav-prev level level-item link-muted" href="/Linux%E7%AE%A1%E9%81%93%E7%AC%A6/"><i class="level-item fas fa-chevron-left"></i><span class="level-item">Linux管道符(&#039;|&#039;)</span></a></div><div class="level-end"><a class="article-nav-next level level-item link-muted" href="/Docker-Machine%E4%BD%BF%E7%94%A8/"><span class="level-item">Docker Machine使用</span><i class="level-item fas fa-chevron-right"></i></a></div></nav><!--!--></div><!--!--><div class="column column-right is-4-tablet is-4-desktop is-4-widescreen  order-3 is-sticky"><div class="card widget" id="toc" data-type="toc"><div class="card-content"><div class="menu"><h3 class="menu-label">目录</h3><ul class="menu-list"><li><a class="level is-mobile" href="#简介"><span class="level-left"><span class="level-item">1</span><span class="level-item">简介</span></span></a></li><li><a class="level is-mobile" href="#相关概念"><span class="level-left"><span class="level-item">2</span><span class="level-item">相关概念</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#节点"><span class="level-left"><span class="level-item">2.1</span><span class="level-item">节点</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#管理节点"><span class="level-left"><span class="level-item">2.1.1</span><span class="level-item">管理节点</span></span></a></li><li><a class="level is-mobile" href="#工作节点"><span class="level-left"><span class="level-item">2.1.2</span><span class="level-item">工作节点</span></span></a></li></ul></li><li><a class="level is-mobile" href="#服务和任务"><span class="level-left"><span class="level-item">2.2</span><span class="level-item">服务和任务</span></span></a></li></ul></li><li><a class="level is-mobile" href="#创建Swarm集群"><span class="level-left"><span class="level-item">3</span><span class="level-item">创建Swarm集群</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#初始化集群"><span class="level-left"><span class="level-item">3.1</span><span class="level-item">初始化集群</span></span></a></li><li><a class="level is-mobile" href="#增加工作节点"><span class="level-left"><span class="level-item">3.2</span><span class="level-item">增加工作节点</span></span></a></li><li><a class="level is-mobile" href="#查看所有节点的IP"><span class="level-left"><span class="level-item">3.3</span><span class="level-item">查看所有节点的IP</span></span></a></li><li><a class="level is-mobile" href="#查看集群"><span class="level-left"><span class="level-item">3.4</span><span class="level-item">查看集群</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#docker-node-ls"><span class="level-left"><span class="level-item">3.4.1</span><span class="level-item">docker node ls</span></span></a></li></ul></li></ul></li><li><a class="level is-mobile" href="#部署服务"><span class="level-left"><span class="level-item">4</span><span class="level-item">部署服务</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#新建服务"><span class="level-left"><span class="level-item">4.1</span><span class="level-item">新建服务</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#docker-service"><span class="level-left"><span class="level-item">4.1.1</span><span class="level-item">docker service</span></span></a></li></ul></li><li><a class="level is-mobile" href="#查看服务"><span class="level-left"><span class="level-item">4.2</span><span class="level-item">查看服务</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#docker-service-ls"><span class="level-left"><span class="level-item">4.2.1</span><span class="level-item">docker service ls</span></span></a></li><li><a class="level is-mobile" href="#docker-service-ps"><span class="level-left"><span class="level-item">4.2.2</span><span class="level-item">docker service ps</span></span></a></li><li><a class="level is-mobile" href="#docker-service-logs"><span class="level-left"><span class="level-item">4.2.3</span><span class="level-item">docker service logs</span></span></a></li></ul></li><li><a class="level is-mobile" href="#访问页面"><span class="level-left"><span class="level-item">4.3</span><span class="level-item">访问页面</span></span></a></li><li><a class="level is-mobile" href="#服务伸缩"><span class="level-left"><span class="level-item">4.4</span><span class="level-item">服务伸缩</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#docker-service-scale"><span class="level-left"><span class="level-item">4.4.1</span><span class="level-item">docker service scale</span></span></a></li></ul></li><li><a class="level is-mobile" href="#删除服务"><span class="level-left"><span class="level-item">4.5</span><span class="level-item">删除服务</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#docker-service-rm"><span class="level-left"><span class="level-item">4.5.1</span><span class="level-item">docker service rm</span></span></a></li></ul></li></ul></li><li><a class="level is-mobile" href="#使用-docker-compose文件"><span class="level-left"><span class="level-item">5</span><span class="level-item">使用 docker compose文件</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#创建docker-compose-yml文件"><span class="level-left"><span class="level-item">5.1</span><span class="level-item">创建docker-compose.yml文件</span></span></a></li><li><a class="level is-mobile" href="#运行docker-compose部署服务"><span class="level-left"><span class="level-item">5.2</span><span class="level-item">运行docker-compose部署服务</span></span></a></li><li><a class="level is-mobile" href="#查看compose服务"><span class="level-left"><span class="level-item">5.3</span><span class="level-item">查看compose服务</span></span></a></li><li><a class="level is-mobile" href="#查看compose容器"><span class="level-left"><span class="level-item">5.4</span><span class="level-item">查看compose容器</span></span></a></li><li><a class="level is-mobile" href="#移除服务"><span class="level-left"><span class="level-item">5.5</span><span class="level-item">移除服务</span></span></a></li><li><a class="level is-mobile" href="#更新服务"><span class="level-left"><span class="level-item">5.6</span><span class="level-item">更新服务</span></span></a></li></ul></li><li><a class="level is-mobile" href="#管理密钥"><span class="level-left"><span class="level-item">6</span><span class="level-item">管理密钥</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#创建secret"><span class="level-left"><span class="level-item">6.1</span><span class="level-item">创建secret</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#文件创建"><span class="level-left"><span class="level-item">6.1.1</span><span class="level-item">文件创建</span></span></a></li><li><a class="level is-mobile" href="#管道符形式创建"><span class="level-left"><span class="level-item">6.1.2</span><span class="level-item">管道符形式创建</span></span></a></li></ul></li><li><a class="level is-mobile" href="#查看secret"><span class="level-left"><span class="level-item">6.2</span><span class="level-item">查看secret</span></span></a></li><li><a class="level is-mobile" href="#使用secret创建服务"><span class="level-left"><span class="level-item">6.3</span><span class="level-item">使用secret创建服务</span></span></a></li><li><a class="level is-mobile" href="#查看通过secret创建的服务"><span class="level-left"><span class="level-item">6.4</span><span class="level-item">查看通过secret创建的服务</span></span></a></li><li><a class="level is-mobile" href="#删除服务的secret"><span class="level-left"><span class="level-item">6.5</span><span class="level-item">删除服务的secret</span></span></a></li></ul></li><li><a class="level is-mobile" href="#管理配置信息"><span class="level-left"><span class="level-item">7</span><span class="level-item">管理配置信息</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#创建config"><span class="level-left"><span class="level-item">7.1</span><span class="level-item">创建config</span></span></a></li><li><a class="level is-mobile" href="#查看config"><span class="level-left"><span class="level-item">7.2</span><span class="level-item">查看config</span></span></a></li><li><a class="level is-mobile" href="#使用config"><span class="level-left"><span class="level-item">7.3</span><span class="level-item">使用config</span></span></a></li></ul></li><li><a class="level is-mobile" href="#滚动升级"><span class="level-left"><span class="level-item">8</span><span class="level-item">滚动升级</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#创建服务"><span class="level-left"><span class="level-item">8.1</span><span class="level-item">创建服务</span></span></a></li><li><a class="level is-mobile" href="#升级服务版本"><span class="level-left"><span class="level-item">8.2</span><span class="level-item">升级服务版本</span></span></a></li><li><a class="level is-mobile" href="#服务回退"><span class="level-left"><span class="level-item">8.3</span><span class="level-item">服务回退</span></span></a></li></ul></li></ul></div></div><style>#toc .menu-list > li > a.is-active + .menu-list { display: block; }#toc .menu-list > li > a + .menu-list { display: none; }</style><script src="/js/toc.js" defer></script></div></div></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/"><img src="/img/common/favicon.ico" alt="buubiu&#039;s技术分享主页" height="28"></a><p class="is-size-7"><span>&copy; 2024 buubiu</span>  Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a><span>  <img src="/img/common/foot-ga.png">  <a title="苏公网安备 32032102000187号" href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=32032102000187" target="_blank" rel="noopener">苏公网安备 32032102000187号</a></span><span>  <img src="/img/common/foot-icp.png">  <a title="苏ICP备2021016911号-1" href="https://beian.miit.gov.cn/" target="_blank" rel="noopener">苏ICP备2021016911号-1</a></span><br><span id="busuanzi_container_site_uv">共<span id="busuanzi_value_site_uv">0</span>个访客</span></p></div><div class="level-end"><div class="field has-addons"><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Attribution 4.0 International" href="https://creativecommons.org/licenses/by/4.0/"><i class="fab fa-creative-commons-by"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/bufx"><i class="fab fa-github"></i></a></p></div></div></div></div></footer><script src="https://cdnjs.loli.net/ajax/libs/jquery/3.3.1/jquery.min.js"></script><script src="https://cdnjs.loli.net/ajax/libs/moment.js/2.22.2/moment-with-locales.min.js"></script><script src="https://cdnjs.loli.net/ajax/libs/clipboard.js/2.0.4/clipboard.min.js" defer></script><script>moment.locale("zh-cn");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script src="/js/column.js"></script><a id="back-to-top" title="回到顶端" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/js/back_to_top.js" defer></script><!--!--><!--!--><!--!--><!--!--><script src="https://cdnjs.loli.net/ajax/libs/cookieconsent/3.1.1/cookieconsent.min.js" defer></script><script>window.addEventListener("load", () => {
      window.cookieconsent.initialise({
        type: "info",
        theme: "edgeless",
        static: false,
        position: "bottom-left",
        content: {
          message: "此网站使用Cookie来改善您的体验。",
          dismiss: "知道了！",
          allow: "允许使用Cookie",
          deny: "拒绝",
          link: "了解更多",
          policy: "Cookie政策",
          href: "https://www.cookiesandyou.com/",
        },
        palette: {
          popup: {
            background: "#edeff5",
            text: "#838391"
          },
          button: {
            background: "#4b81e8"
          },
        },
      });
    });</script><script src="https://cdnjs.loli.net/ajax/libs/lightgallery/1.10.0/js/lightgallery.min.js" defer></script><script src="https://cdnjs.loli.net/ajax/libs/justifiedGallery/3.8.1/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><script type="text/javascript" id="MathJax-script" async>MathJax = {
      tex: {
        inlineMath: [['$', '$'], ['\\(', '\\)']]
      },
      svg: {
        fontCache: 'global'
      },
      chtml: {
        matchFontHeight: false
      }
    };</script><script src="https://cdnjs.loli.net/ajax/libs/mathjax/3.2.2/es5/tex-mml-chtml.js"></script><!--!--><!--!--><!--!--><script src="/js/main.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="想要查找什么..."></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div></div></div><script src="/js/insight.js" defer></script><script>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/content.json"}, {"hint":"想要查找什么...","untitled":"(无标题)","posts":"文章","pages":"页面","categories":"分类","tags":"标签"});
        });</script></body></html>