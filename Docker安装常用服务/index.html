<!doctype html>
<html lang="zh"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta><title>Docker安装常用服务 - buubiu&#039;s技术分享主页</title><link rel="manifest" href="/manifest.json"><meta name="application-name" content="buubiu&#039;s技术分享主页"><meta name="msapplication-TileImage" content="/img/common/favicon.ico"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="buubiu&#039;s技术分享主页"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta name="description" content="基础安装步骤 安装哪个服务就去docker hub搜索对应服务的镜像  点击进入该服务的docker hub，如图：   Description：描述信息 Tags：版本信息   确定使用的版本 docker pull mysql:5.7"><meta property="og:type" content="blog"><meta property="og:title" content="Docker安装常用服务"><meta property="og:url" content="https://blog.buubiu.com/Docker%E5%AE%89%E8%A3%85%E5%B8%B8%E7%94%A8%E6%9C%8D%E5%8A%A1/"><meta property="og:site_name" content="buubiu&#039;s技术分享主页"><meta property="og:description" content="基础安装步骤 安装哪个服务就去docker hub搜索对应服务的镜像  点击进入该服务的docker hub，如图：   Description：描述信息 Tags：版本信息   确定使用的版本 docker pull mysql:5.7"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://blog.buubiu.com/img/article/XyJCZ91615215843559.png"><meta property="og:image" content="https://blog.buubiu.com/img/article/iDj9Ik1615425136418.png"><meta property="article:published_time" content="2021-03-08T15:01:19.000Z"><meta property="article:modified_time" content="2024-01-25T15:08:04.800Z"><meta property="article:author" content="buubiu"><meta property="article:tag" content="Docker"><meta property="twitter:card" content="summary"><meta property="twitter:image:src" content="https://blog.buubiu.com/img/article/XyJCZ91615215843559.png"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://blog.buubiu.com/Docker%E5%AE%89%E8%A3%85%E5%B8%B8%E7%94%A8%E6%9C%8D%E5%8A%A1/"},"headline":"Docker安装常用服务","image":["https://blog.buubiu.com/img/article/XyJCZ91615215843559.png","https://blog.buubiu.com/img/article/iDj9Ik1615425136418.png"],"datePublished":"2021-03-08T15:01:19.000Z","dateModified":"2024-01-25T15:08:04.800Z","author":{"@type":"Person","name":"buubiu"},"publisher":{"@type":"Organization","name":"buubiu's技术分享主页","logo":{"@type":"ImageObject","url":"https://blog.buubiu.com/img/common/favicon.ico"}},"description":"基础安装步骤 安装哪个服务就去docker hub搜索对应服务的镜像  点击进入该服务的docker hub，如图：   Description：描述信息 Tags：版本信息   确定使用的版本 docker pull mysql:5.7"}</script><link rel="canonical" href="https://blog.buubiu.com/Docker%E5%AE%89%E8%A3%85%E5%B8%B8%E7%94%A8%E6%9C%8D%E5%8A%A1/"><link rel="icon" href="/img/common/favicon.ico"><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/font-awesome/6.0.0/css/all.min.css"><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/highlight.js/11.7.0/styles/atom-one-light.min.css"><link rel="stylesheet" href="https://fonts.loli.net/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link rel="stylesheet" href="/css/default.css"><!--!--><script>var _hmt = _hmt || [];
        (function() {
            var hm = document.createElement("script");
            hm.src = "//hm.baidu.com/hm.js?3c3ec636275df73c9383cb68964ee62a";
            var s = document.getElementsByTagName("script")[0];
            s.parentNode.insertBefore(hm, s);
        })();</script><!--!--><script src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" defer></script><!--!--><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/cookieconsent/3.1.1/cookieconsent.min.css"><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/lightgallery/1.10.0/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/justifiedGallery/3.8.1/css/justifiedGallery.min.css"><!--!--><!--!--><!--!--><style>.pace{-webkit-pointer-events:none;pointer-events:none;-webkit-user-select:none;-moz-user-select:none;user-select:none}.pace-inactive{display:none}.pace .pace-progress{background:#3273dc;position:fixed;z-index:2000;top:0;right:100%;width:100%;height:2px}</style><script src="https://cdnjs.loli.net/ajax/libs/pace/1.2.4/pace.min.js"></script><!--!--><!--!--><!-- hexo injector head_end start --><script>
  (function () {
      function switchTab() {
          if (!location.hash) {
            return;
          }

          const id = '#' + CSS.escape(location.hash.substring(1));
          const $tabMenu = document.querySelector(`.tabs a[href="${id}"]`);
          if (!$tabMenu) {
            return;
          }

          const $tabMenuContainer = $tabMenu.parentElement.parentElement;
          Array.from($tabMenuContainer.children).forEach($menu => $menu.classList.remove('is-active'));
          Array.from($tabMenuContainer.querySelectorAll('a'))
              .map($menu => document.getElementById($menu.getAttribute("href").substring(1)))
              .forEach($content => $content.classList.add('is-hidden'));

          if ($tabMenu) {
              $tabMenu.parentElement.classList.add('is-active');
          }
          const $activeTab = document.querySelector(id);
          if ($activeTab) {
              $activeTab.classList.remove('is-hidden');
          }
      }
      switchTab();
      window.addEventListener('hashchange', switchTab, false);
  })();
  </script><!-- hexo injector head_end end --><meta name="generator" content="Hexo 6.3.0"></head><body class="is-2-column"><nav class="navbar navbar-main"><div class="container navbar-container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/"><img src="/img/common/favicon.ico" alt="buubiu&#039;s技术分享主页" height="28"></a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">Home</a><a class="navbar-item" href="/archives">Archives</a><a class="navbar-item" href="/categories">Categories</a><a class="navbar-item" href="/tags">Tags</a><a class="navbar-item" href="/about">About</a></div><div class="navbar-end"><a class="navbar-item" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/bufx"><i class="fab fa-github"></i></a><a class="navbar-item is-hidden-tablet catalogue" title="目录" href="javascript:;"><i class="fas fa-list-ul"></i></a><a class="navbar-item search" title="搜索" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-8-widescreen"><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2021-03-08T15:01:19.000Z" title="2021/3/8 23:01:19">2021-03-08</time>发表</span><span class="level-item"><time dateTime="2024-01-25T15:08:04.800Z" title="2024/1/25 23:08:04">2024-01-25</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/Docker/">Docker</a></span><span class="level-item">32 分钟读完 (大约4831个字)</span><span class="level-item" id="busuanzi_container_page_pv"><span id="busuanzi_value_page_pv">0</span>次访问</span></div></div><h1 class="title is-3 is-size-4-mobile">Docker安装常用服务</h1><div class="content"><h2 id="基础安装步骤"><a href="#基础安装步骤" class="headerlink" title="基础安装步骤"></a>基础安装步骤</h2><ol>
<li><p>安装哪个服务就去docker hub搜索对应服务的镜像</p>
</li>
<li><p>点击进入该服务的docker hub，如图：</p>
<p><img src="/../img/article/XyJCZ91615215843559.png"></p>
<ol>
<li>Description：描述信息</li>
<li>Tags：版本信息</li>
</ol>
</li>
<li><p>确定使用的版本</p>
<p><code>docker pull mysql:5.7</code></p>
</li>
</ol>
<span id="more"></span>

<h2 id="安装mysql"><a href="#安装mysql" class="headerlink" title="安装mysql"></a>安装mysql</h2><ul>
<li><p>基本启动mysql服务</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker <span class="keyword">run</span><span class="language-bash"> -e MYSQL_ROOT_PASSWORD=root mysql:5.7</span></span><br><span class="line"><span class="comment"># -e MYSQL_ROOT_PASSWORD=root e是指环境变量；代表给root用户指定密码</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>启动一个mysql服务，后台运行，指定映射端口，指定root用户密码，指定容器名字</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker <span class="keyword">run</span><span class="language-bash"> -d -p 3307:3306 -e MYSQL_ROOT_PASSWORD=root --name mysql mysql:5.7</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>启动一个mysql服务，后台运行，指定映射端口，指定root用户密码，指定容器名字，使用数据卷将数据持久化到宿主机系统</p>
<p><strong>注意：通过docker hub描述得知，mysql存储数据文件目录是<code>/var/lib/mysql</code></strong></p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker <span class="keyword">run</span><span class="language-bash"> -d -p 3307:3306 -e MYSQL_ROOT_PASSWORD=root --name mysql -v mysqldata:/var/lib/mysql mysql:5.7</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>启动一个mysql服务，后台运行，指定映射端口，指定root用户密码，指定容器名字，使用数据卷将数据持久化到宿主机系统，用已修改之后的配置文件启动</p>
<p><strong>注意：通过docker hub描述得知，mysql配置文件的路径是<code>/etc/mysql</code></strong></p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker <span class="keyword">run</span><span class="language-bash"> -d -p 3307:3306 -e MYSQL_ROOT_PASSWORD=root --name mysql -v mysqldata:/var/lib/mysql -v mysqlconfig:/etc/mysql mysql:5.7</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>将mysql数据库备份为sql文件</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#导出全部数据</span></span><br><span class="line">docker exec mysql|容器id sh -c <span class="string">&#x27;exec mysqldump --all-databases -uroot -p&quot;$MYSQL_ROOT_PASSWORD&quot;&#x27;</span> &gt; /root/all-databases.sql</span><br><span class="line"></span><br><span class="line"><span class="comment">#导出指定库数据</span></span><br><span class="line">docker exec mysql sh -c <span class="string">&#x27;exec mysqldump --databases 库表 -uroot -p&quot;$MYSQL_ROOT_PASSWORD&quot;&#x27;</span> &gt; /root/all-databases.sql</span><br><span class="line"></span><br><span class="line"><span class="comment">#导出指定库数据不要数据</span></span><br><span class="line">docker exec mysql sh -c <span class="string">&#x27;exec mysqldump --no-data --databases 库表 -uroot -p&quot;$MYSQL_ROOT_PASSWORD&quot;&#x27;</span> &gt; /root/all-databases.sql</span><br></pre></td></tr></table></figure>
</li>
<li><p>执行sql文件到mysql中</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker exec -i mysql sh -c <span class="string">&#x27;exec mysql -uroot -p&quot;$MYSQL_ROOT_PASSWORD&quot;&#x27;</span> &lt; /root/xxx.sql</span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="安装tomcat"><a href="#安装tomcat" class="headerlink" title="安装tomcat"></a>安装tomcat</h2><ul>
<li><p>启动一个基本tomcat服务</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker <span class="keyword">run</span><span class="language-bash"> -d -p 8081:8080 --name tomcat tomcat:8.0-jre8</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>启动tomcat服务，并将部署应用目录通过数据卷挂载到宿主机系统</p>
<p><strong>注意：通过docker hub描述得知，部署web应用在容器中目录为<code>/usr/local/tomcat/webapps</code></strong></p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker <span class="keyword">run</span><span class="language-bash"> -d -p 8081:8080 --name tomcat -v apps:/usr/local/tomcat/webapps tomcat:8.0-jre8</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>修改配置文件，并将部署应用目录通过数据卷挂载到宿主机系统（如果修改端口的话，需要重新起一个容器才能生效）</p>
<p><strong>注意：通过docker hub描述得知，配置文件在<code>/usr/local/tomcat/conf</code></strong></p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker <span class="keyword">run</span><span class="language-bash"> -d -p 8081:8080 --name tomcat -v apps:/usr/local/tomcat/webapps -v confs:/usr/local/tomcat/conf tomcat:8.0-jre8</span></span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="安装redis"><a href="#安装redis" class="headerlink" title="安装redis"></a>安装redis</h2><ul>
<li><p>启动一个基本redis服务</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker <span class="keyword">run</span><span class="language-bash"> -d -p 6379:6379 --name redis redis:5.0</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>开启redis持久化(<code> --appendonly yes</code>)，并将持久化的目录通过数据卷挂载到宿主机系统</p>
<p><strong>注意：一旦开启持久化后，持久化生成的aof文件会被放入容器中<code>/data</code>目录中</strong></p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker <span class="keyword">run</span><span class="language-bash"> -d -p 6379:6379 -v redisdata:/data --appendonly <span class="built_in">yes</span> --name redis redis:5.0</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>加载外部配置文件，以配置文件方式启动</p>
<p><strong>注意：</strong></p>
<p><strong>1. 默认情况下redis官方镜像中没有redis.conf配置文件 需要去官网下载指定版本的配置文件</strong></p>
<p><strong>2. 将官方安装包中配置文件进行复制到宿主机指定目录中如 &#x2F;root&#x2F;redis&#x2F;redis.conf文件</strong></p>
<p><strong>3. 修改需要自定义的配置</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">bind 0.0.0.0 开启远程权限</span><br><span class="line">appenonly yes 开启aof持久化</span><br></pre></td></tr></table></figure>

<p><strong>4. 加载配置启动，并让配置生效(<code>redis-server /usr/local/etc/redis/redis.conf</code>)</strong></p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker <span class="keyword">run</span><span class="language-bash"> -d -p 6379:6379 -v /root/redis/redis.conf:/usr/local/etc/redis --name redis redis:5.0 redis-server /usr/local/etc/redis/redis.conf</span></span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="安装nginx"><a href="#安装nginx" class="headerlink" title="安装nginx"></a>安装nginx</h2><ul>
<li><p>启动一个基本nginx服务</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker <span class="keyword">run</span><span class="language-bash"> -d -p 80:80 --name mynginx nginx</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>挂载nginx配置文件以及html到宿主机系统</p>
<ol>
<li><p>进入容器</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker exec -it mynginx /bin/bash</span><br></pre></td></tr></table></figure>
</li>
<li><p>查找目录：<code>whereis nginx</code></p>
</li>
<li><p>配置文件路径：<code>/etc/nginx/nginx.conf</code></p>
</li>
<li><p>复制配置文件到宿主机</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker cp mynginx(容器id|容器名称):/etc/nginx/nginx.conf /root/nginx/nginx.conf(宿主机目录)</span><br></pre></td></tr></table></figure>
</li>
<li><p>启动容器</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker <span class="keyword">run</span><span class="language-bash"> -d -p 80:80 --name mynginx -v /root/nginx/nginx.conf:/etc/nginx/nginx.conf -v /root/nginx/html:/usr/share/nginx/html nginx</span></span><br></pre></td></tr></table></figure></li>
</ol>
</li>
</ul>
<h2 id="安装elasticsearch"><a href="#安装elasticsearch" class="headerlink" title="安装elasticsearch"></a>安装elasticsearch</h2><ul>
<li><p>启动一个基础服务</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker <span class="keyword">run</span><span class="language-bash"> -d -p 9200:9200 -p 9300:9300 --name elasticsearch -e <span class="string">&quot;discovery.type=single-node&quot;</span> elasticsearch:7.9.3</span></span><br></pre></td></tr></table></figure>

<p><strong>注意：如果启动出现如下错误的解决办法</strong></p>
<p><img src="/../img/article/iDj9Ik1615425136418.png"></p>
<ul>
<li>在centos中修改配置<code>/etc/sysctl.conf</code></li>
<li>加入或修改如下配置 <code>vm.max_map_count=262144</code></li>
<li>启用配置<code>sysctl -p</code></li>
</ul>
</li>
<li><p>启动服务，并持久化索引数据和配置</p>
<p><strong>注意：</strong></p>
<p><strong>1. ES中所有数据都在容器中的<code>/usr/share/elasticsearch/data</code></strong></p>
<p><strong>2. ES中的配置文件在容器中的<code>/usr/share/elasticsearch/config</code></strong></p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker <span class="keyword">run</span><span class="language-bash"> -d -p 9200:9200 -p 9300:9300 --name elasticsearch -e <span class="string">&quot;discovery.type=single-node&quot;</span>  -v esdata:/usr/share/elasticsearch/data -v esconfig:/usr/share/elasticsearch/config elasticsearch:7.9.3</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>启动服务，并持久化索引数据，持久化配置，安装ik分词器</p>
<p><strong>注意：ES中的分词插件路径为<code>/usr/share/elasticsearch/plugins</code></strong></p>
<ol>
<li><p>下载对应版本的IK分词器</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget https://github.com/medcl/elasticsearch-analysis-ik/releases/download/v7.9.3/elasticsearch-analysis-ik-7.9.3.zip</span><br></pre></td></tr></table></figure>
</li>
<li><p>解压到plugins文件夹中</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">yum install -y unzip</span><br><span class="line">unzip -d ik elasticsearch-analysis-ik-7.9.3.zip</span><br></pre></td></tr></table></figure>
</li>
<li><p>添加自定义扩展词和停用词</p>
<p><code>vim plugins/elasticsearch/config/IKAnalyzer.cfg.xml</code></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&lt;properties&gt;</span><br><span class="line">  &lt;comment&gt;IK Analyzer 扩展配置&lt;/comment&gt;</span><br><span class="line">  &lt;!--用户可以在这里配置自己的扩展字典 --&gt;</span><br><span class="line">  &lt;entry key=&quot;ext_dict&quot;&gt;ext_dict.dic&lt;/entry&gt;</span><br><span class="line">  &lt;!--用户可以在这里配置自己的扩展停止词字典--&gt;</span><br><span class="line">  &lt;entry key=&quot;ext_stopwords&quot;&gt;ext_stopwords.dic&lt;/entry&gt;</span><br><span class="line">&lt;/properties&gt;</span><br></pre></td></tr></table></figure>
</li>
<li><p>在ik分词器目录下config目录中创建ext_dict.dic文件   编码一定要为UTF-8才能生效</p>
<p><code>vim ext_dict.dic </code>加入扩展词即可</p>
</li>
<li><p>在ik分词器目录下config目录中创建ext_stopword.dic文件 </p>
<p><code>vim ext_stopwords.dic </code>加入停用词即可</p>
</li>
<li><p>启动容器生效</p>
</li>
</ol>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker <span class="keyword">run</span><span class="language-bash"> -d -p 9200:9200 -p 9300:9300 --name elasticsearch -e <span class="string">&quot;discovery.type=single-node&quot;</span>  -v esdata:/usr/share/elasticsearch/data -v esconfig:/usr/share/elasticsearch/config -v esplugins:/usr/share/elasticsearch/plugins elasticsearch:7.9.3</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>加密es登录</p>
<p>在启动命令中加入环境变量：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ docker run -d -p 9200:9200 -p 9300:9300 \</span><br><span class="line">  ---name elasticsearch \</span><br><span class="line">  -e <span class="string">&quot;discovery.type=single-node&quot;</span> \</span><br><span class="line">  -v esdata:/usr/share/elasticsearch/data \</span><br><span class="line">  -v esconfig:/usr/share/elasticsearch/config \</span><br><span class="line">  -v esplugins:/usr/share/elasticsearch/plugins \</span><br><span class="line">  -e xpack.security.enabled=<span class="literal">true</span> \</span><br><span class="line">  -e xpack.security.transport.ssl.enabled: <span class="literal">true</span> \</span><br><span class="line">  -e ELASTIC_PASSWORD=buubiu</span><br><span class="line">  elasticsearch:7.9.3</span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="安装kibana"><a href="#安装kibana" class="headerlink" title="安装kibana"></a>安装kibana</h2><ul>
<li><p>启动一个基本的kibana服务</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker <span class="keyword">run</span><span class="language-bash"> -d -p 5601:5601 --name kibana kibana:7.9.3</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>启动kibana，并通过设置环境变量连接ES <code>-e ELASTICSEARCH_HOSTS</code></p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker <span class="keyword">run</span><span class="language-bash"> -d -p 5601:5601 -e ELASTICSEARCH_HOSTS=http://127.0.0.1:9200 --name kibana kibana:7.9.3</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>启动kibana，并通过配置文件连接ES</p>
<p><strong>注意：kibana的配置文件在容器中<code>/usr/share/kibana/config</code></strong></p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker <span class="keyword">run</span><span class="language-bash"> -d -p 5601:5601 -v kibanaconif:/usr/share/kibana/config --name kibana kibana:7.9.3</span></span><br></pre></td></tr></table></figure>

<ol>
<li><p>修改宿主机中kibana的配置文件kibana.yml</p>
<p>若es加了用户名密码访问，则还需要追加后两行：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">elasticsearcch.hosts:[&quot;http://127.0.0.1:9200&quot;]</span><br><span class="line">elasticsearch.username: &quot;kibana&quot;</span><br><span class="line">elasticsearch.password: &quot;Aa000000&quot;</span><br><span class="line">xpack.security.enabled: true</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">32位以上的随机数即可，用作信息的加密</span></span><br><span class="line">xpack.security.encryptionKey: &quot;4297f44b13955235245b2497399d7a93&quot; </span><br></pre></td></tr></table></figure>
</li>
<li><p>重启容器即可</p>
</li>
<li><p>登录kibana的时候，输入的用户名和密码是:elastic&#x2F;Aa000000</p>
</li>
</ol>
</li>
</ul>
<h2 id="安装mariadb"><a href="#安装mariadb" class="headerlink" title="安装mariadb"></a>安装mariadb</h2><p>与mysql类似</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ docker load -i mariadb-10.2.12.tar</span><br><span class="line">$ <span class="built_in">mkdir</span> -p /home/mariadb/data /home/mariadb/binlog</span><br><span class="line">$ docker run -d -p 3306:3306 -e MYSQL_ROOT_PASSWORD=root --name mariadb --mount <span class="built_in">type</span>=<span class="built_in">bind</span>,<span class="built_in">source</span>=/home/mariadb/binlog,target=/var/log/mysql/mariadb-bin --restart=always -v /home/mariadb/data:/var/lib/mysql mariadb:10.2.12</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建并开启binlog</span></span><br><span class="line">$ docker <span class="built_in">exec</span> mariadb bash -c <span class="string">&quot;echo &#x27;log_bin=/var/log/mysql/mariadb-bin&#x27; &gt;&gt; /etc/mysql/mariadb.cnf&quot;</span></span><br><span class="line">$ docker <span class="built_in">exec</span> mariadb bash -c <span class="string">&quot;echo &#x27;server-id=123456&#x27; &gt;&gt; /etc/mysql/mariadb.cnf&quot;</span></span><br></pre></td></tr></table></figure>

<h2 id="安装nacos"><a href="#安装nacos" class="headerlink" title="安装nacos"></a>安装nacos</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ docker run -d -p 8848:8848 -e MODE=standalone --name nacos nacos/nacos-server:1.4.1</span><br></pre></td></tr></table></figure>

<h2 id="安装apollo"><a href="#安装apollo" class="headerlink" title="安装apollo"></a>安装apollo</h2><p>初始化sql</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ docker <span class="built_in">exec</span> -i mariadb sh -c <span class="string">&#x27;exec mysql -uroot -p&quot;$MYSQL_ROOT_PASSWORD&quot;&#x27;</span> &lt; /opt/software/docker-images/apollo/apollo_sql/apolloconfigdb.sql</span><br><span class="line">$ docker <span class="built_in">exec</span> -i mariadb sh -c <span class="string">&#x27;exec mysql -uroot -p&quot;$MYSQL_ROOT_PASSWORD&quot;&#x27;</span> &lt; /opt/software/docker-images/apollo/apollo_sql/apolloportaldb.sql</span><br></pre></td></tr></table></figure>

<p>通过sql脚本修改默认config地址：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">UPDATE</span> ApolloConfigDB.ServerConfig t <span class="keyword">SET</span> t.Value <span class="operator">=</span> <span class="string">&#x27;http://192.168.91.100:8080/eureka/&#x27;</span> <span class="keyword">WHERE</span> t.Id <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line"><span class="keyword">UPDATE</span> ApolloPortalDB.ServerConfig t <span class="keyword">SET</span> t.Value <span class="operator">=</span> <span class="string">&#x27;[&#123;&quot;orgId&quot;:&quot;TEST1&quot;,&quot;orgName&quot;:&quot;样例部门1&quot;&#125;,&#123;&quot;orgId&quot;:&quot;TEST2&quot;,&quot;orgName&quot;:&quot;样例部门2&quot;&#125;,&#123;&quot;orgId&quot;:&quot;BOMS&quot;,&quot;orgName&quot;:&quot;BOMS&quot;&#125;]&#x27;</span> <span class="keyword">WHERE</span> t.Id <span class="operator">=</span> <span class="number">2</span>;</span><br></pre></td></tr></table></figure>

<p>导入apollo镜像，并启动：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">$ docker run -d -p 8080:8080 \</span><br><span class="line"> -e SPRING_DATASOURCE_URL=<span class="string">&quot;jdbc:mysql://192.168.91.100:3306/ApolloConfigDB?characterEncoding=utf8&quot;</span> \</span><br><span class="line"> -e SPRING_DATASOURCE_USERNAME=root \</span><br><span class="line"> -e SPRING_DATASOURCE_PASSWORD=root \</span><br><span class="line"> -e EUREKA_INSTANCE_IP_ADDRESS=192.168.91.100 \</span><br><span class="line"> --name apollo-configservice apolloconfig/apollo-configservice:1.7.1</span><br><span class="line"> </span><br><span class="line">$ docker run -d -p 8090:8090 \</span><br><span class="line"> -e SPRING_DATASOURCE_URL=<span class="string">&quot;jdbc:mysql://192.168.91.100:3306/ApolloConfigDB?characterEncoding=utf8&quot;</span> \</span><br><span class="line"> -e SPRING_DATASOURCE_USERNAME=root \</span><br><span class="line"> -e SPRING_DATASOURCE_PASSWORD=root \</span><br><span class="line"> -e EUREKA_INSTANCE_IP_ADDRESS=192.168.91.100 \</span><br><span class="line"> --name apollo-adminservice apolloconfig/apollo-adminservice:1.7.1</span><br><span class="line"> </span><br><span class="line">$ docker run -d -p 8070:8070 \</span><br><span class="line"> -e SPRING_DATASOURCE_URL=<span class="string">&quot;jdbc:mysql://192.168.91.100:3306/ApolloPortalDB?characterEncoding=utf8&quot;</span> \</span><br><span class="line"> -e SPRING_DATASOURCE_USERNAME=root \</span><br><span class="line"> -e SPRING_DATASOURCE_PASSWORD=root \</span><br><span class="line"> -e APOLLO_PORTAL_ENVS=dev \</span><br><span class="line"> -e DEV_META=http://192.168.91.100:8080 \</span><br><span class="line"> --name apollo-portal apolloconfig/apollo-portal:1.7.1</span><br></pre></td></tr></table></figure>

<h2 id="安装Zookeeper"><a href="#安装Zookeeper" class="headerlink" title="安装Zookeeper"></a>安装Zookeeper</h2><p>创建挂载目录：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">mkdir</span> -p /home/zookeeper</span><br></pre></td></tr></table></figure>

<p>先不挂载目录启动容器，然后把相应的目录拷贝出来</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ docker run -d -p 2181:2181 \</span><br><span class="line">--name zookeeper zookeeper:3.7.0</span><br><span class="line">$ docker <span class="built_in">cp</span> zookeeper:/conf /home/zookeeper</span><br><span class="line">$ docker <span class="built_in">cp</span> zookeeper:/data /home/zookeeper</span><br></pre></td></tr></table></figure>

<p>修改配置文件：</p>
<p>路径：<code>/home/zookeeper/conf/zoo.cfg</code></p>
<ul>
<li>若是集群需要修改server.1，否则不需要变</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">dataDir=/data</span></span><br><span class="line"><span class="string">dataLogDir=/datalog</span></span><br><span class="line"><span class="string">tickTime=2000</span></span><br><span class="line"><span class="string">initLimit=5</span></span><br><span class="line"><span class="string">syncLimit=2</span></span><br><span class="line"><span class="string">autopurge.snapRetainCount=3</span></span><br><span class="line"><span class="string">autopurge.purgeInterval=0</span></span><br><span class="line"><span class="string">maxClientCnxns=60</span></span><br><span class="line"><span class="string">standaloneEnabled=true</span></span><br><span class="line"><span class="string">admin.enableServer=true</span></span><br><span class="line"><span class="string">server.1=localhost:2888:3888;2181</span></span><br></pre></td></tr></table></figure>

<p>删除zookeeper容器，重新以挂载目录启动:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ docker run -d -p 2181:2181 \</span><br><span class="line"> -v /home/zookeeper/conf:/conf \</span><br><span class="line"> -v /home/zookeeper/data:/data \</span><br><span class="line"> --name zookeeper zookeeper:3.7.0</span><br></pre></td></tr></table></figure>

<h2 id="安装Kafka"><a href="#安装Kafka" class="headerlink" title="安装Kafka"></a>安装Kafka</h2><p>创建挂载目录：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">mkdir</span> -p /home/kafka</span><br></pre></td></tr></table></figure>

<p>先不挂载目录启动容器，然后把相应的目录拷贝出来</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ docker run -d -p 9092:9092 \</span><br><span class="line"> -e KAFKA_BROKER_ID=0 \</span><br><span class="line"> -e KAFKA_ZOOKEEPER_CONNECT=192.168.91.100:2181/kafka \</span><br><span class="line"> -e KAFKA_ADVERTISED_LISTENERS=PLAINTEXT://192.168.91.100:9092 \</span><br><span class="line"> -e KAFKA_LISTENERS=PLAINTEXT://0.0.0.0:9092 \</span><br><span class="line"> -v /etc/localtime:/etc/localtime \</span><br><span class="line"> --name kafka wurstmeister/kafka:2.13-2.7.0</span><br><span class="line">$ docker <span class="built_in">cp</span> kafka:/opt/kafka/config /home/kafka</span><br></pre></td></tr></table></figure>

<p>删除kafka容器，重新以挂载目录启动:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ docker run -d -p 9092:9092 \</span><br><span class="line"> -e KAFKA_BROKER_ID=0 \</span><br><span class="line"> -e KAFKA_ZOOKEEPER_CONNECT=192.168.91.100:2181/kafka \</span><br><span class="line"> -e KAFKA_ADVERTISED_LISTENERS=PLAINTEXT://192.168.91.100:9092 \</span><br><span class="line"> -e KAFKA_LISTENERS=PLAINTEXT://0.0.0.0:9092 \</span><br><span class="line"> -v /home/kafka/config:/opt/kafka/config \</span><br><span class="line"> -v /etc/localtime:/etc/localtime \</span><br><span class="line"> --name kafka wurstmeister/kafka:2.13-2.7.0</span><br></pre></td></tr></table></figure>

<h2 id="安装Logstash"><a href="#安装Logstash" class="headerlink" title="安装Logstash"></a>安装Logstash</h2><p>创建挂载目录：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">mkdir</span> -p /home/logstash</span><br></pre></td></tr></table></figure>

<p>先不挂载目录启动容器，然后把相应的目录拷贝出来</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ docker run -d -p 5044:5044 -p 9600:9600 \</span><br><span class="line">  --privileged=<span class="literal">true</span>  \</span><br><span class="line">  --name logstash logstash:7.9.3</span><br><span class="line">$ docker <span class="built_in">cp</span> logstash:/usr/share/logstash/config/ /home/logstash</span><br><span class="line">$ docker <span class="built_in">cp</span> logstash:/usr/share/logstash/pipeline/ /home/logstash</span><br></pre></td></tr></table></figure>

<p>修改配置文件：</p>
<p>路径：<code>/home/logstash/config/logstash.yml</code></p>
<ul>
<li>把es地址写上，若是集群就用逗号隔开，格式[“”,””,””]</li>
<li>后面三行直接追加</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">http.host:</span> <span class="string">&quot;0.0.0.0&quot;</span></span><br><span class="line"><span class="attr">xpack.monitoring.elasticsearch.hosts:</span> [ <span class="string">&quot;http://192.168.91.100:9200&quot;</span> ]</span><br><span class="line"><span class="attr">path.config:</span> <span class="string">/usr/share/logstash/pipeline/*.conf</span></span><br><span class="line"><span class="attr">pipeline.batch.size:</span> <span class="number">500</span></span><br><span class="line"><span class="attr">pipeline.batch.delay:</span> <span class="number">50</span></span><br><span class="line"><span class="comment"># 若es有安全校验，加上如下三行，用户名不用变，修改相应的密码即可</span></span><br><span class="line"><span class="attr">xpack.monitoring.enabled:</span> <span class="literal">true</span></span><br><span class="line"><span class="comment"># 若是docker启动的es，用户名写elastic，若是虚拟机启动的，用户名写 logstash_system</span></span><br><span class="line"><span class="attr">xpack.monitoring.elasticsearch.username:</span> <span class="string">elastic</span></span><br><span class="line"><span class="attr">xpack.monitoring.elasticsearch.password:</span> <span class="string">Aa000000</span></span><br></pre></td></tr></table></figure>

<p>新建配置文件</p>
<ul>
<li>并修改相应的kafka地址 <code>192.168.91.100:9092</code></li>
<li>es地址 <code>10.10.23.85:9200</code>，若是集群，格式[“”,””,””]</li>
<li>日志名前缀 <code>jnbank-logs</code></li>
<li>若es有安全校验，在elasticsearch配置的地方加上相应的密码即可</li>
</ul>
<p>路径：<code>/home/logstash/pipeline/test.conf</code></p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Sample Logstash configuration for creating a simple</span></span><br><span class="line"><span class="comment"># Beats -&gt; Logstash -&gt; Elasticsearch pipeline.</span></span><br><span class="line"></span><br><span class="line"><span class="attr">input</span> <span class="string">&#123;</span></span><br><span class="line">  <span class="attr">kafka</span> <span class="string">&#123;</span></span><br><span class="line">    <span class="attr">codec</span> =<span class="string">&gt; &quot;json&quot;</span></span><br><span class="line">    <span class="attr">topics</span> =<span class="string">&gt; [&quot;elk-log&quot;]</span></span><br><span class="line">    <span class="attr">bootstrap_servers</span> =<span class="string">&gt; &quot;192.168.91.100:9092&quot;</span></span><br><span class="line">    <span class="attr">auto_offset_reset</span> =<span class="string">&gt; &quot;latest&quot;</span></span><br><span class="line">  <span class="attr">&#125;</span></span><br><span class="line"><span class="attr">&#125;</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">#input &#123;</span></span><br><span class="line"><span class="comment">#  beats &#123;</span></span><br><span class="line"><span class="comment">#    port =&gt; 5044</span></span><br><span class="line"><span class="comment">#    codec =&gt; json</span></span><br><span class="line"><span class="comment">#    codec =&gt; multiline</span></span><br><span class="line"><span class="comment">#    &#123;</span></span><br><span class="line"><span class="comment">#      pattern =&gt; &quot;^[0-9]&#123;4&#125;-[0-9]&#123;2&#125;-[0-9]&#123;2&#125;&quot;</span></span><br><span class="line"><span class="comment">#      negate =&gt; true</span></span><br><span class="line"><span class="comment">#      what =&gt; &quot;previous&quot;</span></span><br><span class="line"><span class="comment">#    &#125;</span></span><br><span class="line"><span class="comment">#  &#125;</span></span><br><span class="line"><span class="comment">#&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">filter</span> <span class="string">&#123;</span></span><br><span class="line">  <span class="attr">if</span> <span class="string">&quot;test-logs&quot; in [tags] &#123;</span></span><br><span class="line">    <span class="attr">json</span> <span class="string">&#123;</span></span><br><span class="line">      <span class="attr">source</span> =<span class="string">&gt; &quot;message&quot;</span></span><br><span class="line">      <span class="attr">target</span> =<span class="string">&gt; &quot;messages&quot;</span></span><br><span class="line">    <span class="attr">&#125;</span></span><br><span class="line">	</span><br><span class="line">    <span class="attr">date</span> <span class="string">&#123;</span></span><br><span class="line">      <span class="attr">match</span> =<span class="string">&gt; [&quot;[messages][timestamp]&quot;,&quot;yyyy-MM-dd HH:mm:ss.SSS&quot;]</span></span><br><span class="line">      <span class="attr">target</span> =<span class="string">&gt; &quot;@log_timestamp&quot;</span></span><br><span class="line"><span class="comment">      #timezone =&gt; &quot;Asia/Shanghai&quot;</span></span><br><span class="line">    <span class="attr">&#125;</span></span><br><span class="line"></span><br><span class="line">    <span class="attr">ruby</span> <span class="string">&#123;</span></span><br><span class="line">      <span class="attr">code</span> =<span class="string">&gt; &quot;</span></span><br><span class="line">        <span class="attr">path</span> = <span class="string">event.get(&#x27;log&#x27;)[&#x27;file&#x27;][&#x27;path&#x27;]</span></span><br><span class="line"><span class="comment">        #puts format(&#x27;path = %&lt;path&gt;s&#x27;, path: path)</span></span><br><span class="line">        <span class="attr">if</span> <span class="string">(!path.nil?) &amp;&amp; (!path.empty?)</span></span><br><span class="line">          <span class="attr">event.set(&#x27;app_index&#x27;,</span> <span class="string">path.split(&#x27;/&#x27;)[-1].split(&#x27;.&#x27;)[0])</span></span><br><span class="line">        <span class="attr">end</span></span><br><span class="line">        <span class="attr">mytid</span> = <span class="string">event.get(&#x27;messages&#x27;)[&#x27;tid&#x27;]</span></span><br><span class="line">        <span class="attr">if</span> <span class="string">(!mytid.nil?) &amp;&amp; (!mytid.empty?)</span></span><br><span class="line">          <span class="attr">event.set(&#x27;tid&#x27;,mytid.split(&#x27;</span>:<span class="string">&#x27;)[1])</span></span><br><span class="line">        <span class="attr">end</span></span><br><span class="line"><span class="comment">        #event.set(&#x27;@log_timestamp&#x27;,event.get(&#x27;@log_timestamp&#x27;).time.localtime - 8*60*60)</span></span><br><span class="line">      <span class="attr">&quot;</span></span><br><span class="line">    <span class="attr">&#125;</span>	<span class="string"></span></span><br><span class="line">	</span><br><span class="line">    <span class="attr">mutate&#123;</span></span><br><span class="line">      <span class="attr">add_field</span>=<span class="string">&gt;&#123;</span></span><br><span class="line">        <span class="attr">&#x27;thread&#x27;</span> =<span class="string">&gt; &quot;%&#123;[messages][thread]&#125;&quot;</span></span><br><span class="line">        <span class="attr">&#x27;level&#x27;</span> =<span class="string">&gt; &quot;%&#123;[messages][level]&#125;&quot;</span></span><br><span class="line">        <span class="attr">&#x27;logger_name&#x27;</span> =<span class="string">&gt; &quot;%&#123;[messages][logger_name]&#125;&quot;</span></span><br><span class="line">      <span class="attr">&#125;</span></span><br><span class="line">      <span class="attr">remove_field</span> =<span class="string">&gt; [&quot;agent&quot;,&quot;ecs&quot;,&quot;@version&quot;,&quot;host&quot;,&quot;messages&quot;]</span></span><br><span class="line">    <span class="attr">&#125;</span></span><br><span class="line">  <span class="attr">&#125;</span></span><br><span class="line"><span class="attr">&#125;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="attr">output</span> <span class="string">&#123;</span></span><br><span class="line">  <span class="attr">if</span> <span class="string">&quot;test-logs&quot; in [tags] &#123;</span></span><br><span class="line">    <span class="attr">elasticsearch</span> <span class="string">&#123;</span></span><br><span class="line">      <span class="attr">hosts</span> =<span class="string">&gt; [&quot;192.168.91.100:9200&quot;]</span></span><br><span class="line">      <span class="attr">index</span> =<span class="string">&gt; &quot;%&#123;log_source&#125;-%&#123;+YYYY.MM.dd&#125;&quot;</span></span><br><span class="line">      <span class="attr">user</span> =<span class="string">&gt; &quot;elastic&quot;</span></span><br><span class="line">      <span class="attr">password</span> =<span class="string">&gt; &quot;Aa000000&quot;</span></span><br><span class="line">    <span class="attr">&#125;</span></span><br><span class="line">  <span class="attr">&#125;else&#123;</span></span><br><span class="line">      <span class="attr">elasticsearch</span> <span class="string">&#123;</span></span><br><span class="line">        <span class="attr">hosts</span> =<span class="string">&gt; [&quot;192.168.91.100:9200&quot;]</span></span><br><span class="line">        <span class="attr">index</span> =<span class="string">&gt; &quot;%&#123;my-index&#125;-log-%&#123;+YYYY.MM.dd&#125;&quot;</span></span><br><span class="line">        <span class="attr">user</span> =<span class="string">&gt; &quot;elastic&quot;</span></span><br><span class="line">        <span class="attr">password</span> =<span class="string">&gt; &quot;Aa000000&quot;</span></span><br><span class="line">    <span class="attr">&#125;</span></span><br><span class="line">  <span class="attr">&#125;</span></span><br><span class="line"><span class="comment">#  stdout&#123;</span></span><br><span class="line"><span class="comment">#    codec =&gt; json</span></span><br><span class="line"><span class="comment">#  &#125;</span></span><br><span class="line"><span class="attr">&#125;</span></span><br></pre></td></tr></table></figure>

<p>删除logstash容器，重新以挂载目录启动:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ docker run -d -p 5044:5044 -p 9600:9600 \</span><br><span class="line">   --privileged=<span class="literal">true</span>  \</span><br><span class="line">   -v /home/logstash/config:/usr/share/logstash/config \</span><br><span class="line">   -v /home/logstash/pipeline:/usr/share/logstash/pipeline \</span><br><span class="line">   --name logstash logstash:7.9.3</span><br></pre></td></tr></table></figure>

<h2 id="安装Filebeat"><a href="#安装Filebeat" class="headerlink" title="安装Filebeat"></a>安装Filebeat</h2><p>创建挂载目录：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">mkdir</span> -p /home/filebeat</span><br></pre></td></tr></table></figure>

<p>先不挂载目录启动容器，然后把相应的目录拷贝出来</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ docker run -d --name filebeat docker.elastic.co/beats/filebeat:7.9.3</span><br><span class="line">$ docker <span class="built_in">cp</span> filebeat:/usr/share/filebeat/filebeat.yml /home/filebeat</span><br></pre></td></tr></table></figure>

<p>修改配置文件：</p>
<p>路径：<code>/home/filebeat/filebeat.yml</code>，</p>
<ul>
<li>配置好收集路径规则 <code>- /opt/boms-sc-demo/*/logs/*.log</code></li>
<li>配置好日志前缀 <code>test-logs</code></li>
<li>配置好kafka地址 <code>192.168.91.100:9092</code></li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#=========================== Filebeat inputs =============================</span></span><br><span class="line"><span class="attr">filebeat.inputs:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">type:</span> <span class="string">log</span></span><br><span class="line">  <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">paths:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">/opt/boms-sc-demo/*/logs/*.log</span></span><br><span class="line">  <span class="attr">fields:</span></span><br><span class="line">    <span class="attr">log_source:</span> <span class="string">test-logs</span></span><br><span class="line">  <span class="attr">fields_under_root:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">tags:</span> [<span class="string">&quot;test-logs&quot;</span>]</span><br><span class="line"><span class="comment">#  multiline.pattern: &#x27;^[0-9]&#123;4&#125;-[0-9]&#123;2&#125;-[0-9]&#123;2&#125;&#x27;</span></span><br><span class="line"><span class="comment">#  multiline.negate: true</span></span><br><span class="line"><span class="comment">#  multiline.match: after</span></span><br><span class="line">  </span><br><span class="line"><span class="comment">#output.logstash:</span></span><br><span class="line"><span class="comment">#  enabled: true</span></span><br><span class="line"><span class="comment">#    index: &quot;test-logstash-%&#123;+yyyy.MM.dd&#125;&quot;</span></span><br><span class="line"><span class="comment"># hosts: [&quot;10.10.23.66:5044&quot;]</span></span><br><span class="line"></span><br><span class="line"><span class="attr">output.kafka:</span></span><br><span class="line">  <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">hosts:</span> [<span class="string">&quot;192.168.92.100:9092&quot;</span>]</span><br><span class="line">  <span class="attr">topic:</span> <span class="string">elk-log</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#logging.level: debug</span></span><br></pre></td></tr></table></figure>

<p>删除filebeat容器，重新以挂载目录启动:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ docker run -d --name filebeat \</span><br><span class="line">  -v /home/filebeat/filebeat.yml:/usr/share/filebeat/filebeat.yml \</span><br><span class="line">  docker.elastic.co/beats/filebeat:7.9.3</span><br></pre></td></tr></table></figure>

<h2 id="安装Skywalking"><a href="#安装Skywalking" class="headerlink" title="安装Skywalking"></a>安装Skywalking</h2><p>加载skywalking两个镜像</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ docker load -i skywalking-oap-8.2.0-20210425.tar</span><br><span class="line">$ docker load -i skywalking-ui-8.2.0-20210425.tar</span><br></pre></td></tr></table></figure>

<p>创建一个目录，上传文件夹<code>skywalking-config.tar.gz</code>到此目录并解压缩</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">mkdir</span> -p /home/skywalking</span><br><span class="line">$ <span class="built_in">cd</span> /home/skywalking</span><br><span class="line">$ tar -zxvf skywalking-config.tar.gz</span><br></pre></td></tr></table></figure>

<p>创建挂载目录：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">mkdir</span> -p /home/skywalking/logs</span><br></pre></td></tr></table></figure>

<p>编辑配置：</p>
<p>路径：<code>/home/skywalking/docker-compose/.env</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># skywalking-oap镜像的tag标签，通过docker images获得</span></span><br><span class="line">TAG=8.2.0-20210425</span><br><span class="line"><span class="comment"># jvm</span></span><br><span class="line">JAVA_OPTS=<span class="string">&quot;-Xms256M -Xmx512M&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 是否集群，若是单机填写：standalone，若是集群在nacos和consul中选择</span></span><br><span class="line">SW_CLUSTER=nacos</span><br><span class="line"><span class="comment">#--------如果注册中心是nacos--------</span></span><br><span class="line"><span class="comment"># nacos地址，集群用逗号隔开</span></span><br><span class="line">SW_CLUSTER_NACOS_HOST_PORT=192.168.91.100:8848</span><br><span class="line"><span class="comment"># Nacos Configuration namespace</span></span><br><span class="line">SW_CLUSTER_NACOS_NAMESPACE=public</span><br><span class="line"><span class="comment"># Nacos auth username</span></span><br><span class="line">SW_CLUSTER_NACOS_USERNAME=nacos</span><br><span class="line">SW_CLUSTER_NACOS_PASSWORD=nacos</span><br><span class="line"><span class="comment">#--------如果注册中心是 consul--------</span></span><br><span class="line"><span class="comment"># Consul cluster nodes, example: 10.0.0.1:8500,10.0.0.2:8500,10.0.0.3:8500</span></span><br><span class="line">SW_CLUSTER_CONSUL_HOST_PORT=127.0.0.1:8500</span><br><span class="line"><span class="comment"># token</span></span><br><span class="line">SW_CLUSTER_CONSUL_ACLTOKEN=</span><br><span class="line"></span><br><span class="line"><span class="comment"># restHost</span></span><br><span class="line">SW_CORE_REST_HOST=0.0.0.0</span><br><span class="line"><span class="comment">#链路数据保存的期限，包括链路追踪和告警。单位：天</span></span><br><span class="line">SW_CORE_RECORD_DATA_TTL=3</span><br><span class="line"><span class="comment">#指标数据保存的期限，包括包括百分比，热图，成功率，cpm（rpm）等。单位：天</span></span><br><span class="line">SW_CORE_METRICS_DATA_TTL=7</span><br><span class="line"></span><br><span class="line"><span class="comment"># ----elasticsearch7配置------</span></span><br><span class="line">SW_STORAGE=elasticsearch7</span><br><span class="line"><span class="comment"># 索引前缀配置，谨慎修改，boms工程中broker会用到</span></span><br><span class="line">SW_NAMESPACE=boms</span><br><span class="line"><span class="comment"># es地址，集群用逗号隔开</span></span><br><span class="line">SW_STORAGE_ES_CLUSTER_NODES=192.168.91.100:9200</span><br><span class="line"><span class="comment"># 若es配置了用户名和密码，填写下面两个配置</span></span><br><span class="line">SW_ES_USER=elastic</span><br><span class="line">SW_ES_PASSWORD=Aa000000</span><br><span class="line"></span><br><span class="line"><span class="comment"># ----配置中心apollo----</span></span><br><span class="line">SW_CONFIGURATION=apollo</span><br><span class="line"><span class="comment">#apollo meta地址</span></span><br><span class="line">SW_META_APOLLO=http://192.168.91.100:8080</span><br><span class="line"><span class="comment">#apollo config地址，这个地址和meta地址的值一直，但是作用不同，场景不同。</span></span><br><span class="line"><span class="comment"># 一般情况下都建议使用Apollo的Meta Server机制来实现Config Service的服务发现，从而可以实现Config Service的高可用。不过apollo-client也支持跳过Meta Server服务发现，主要用于以下场景：</span></span><br><span class="line"><span class="comment"># #</span></span><br><span class="line"><span class="comment"># #1. Config Service部署在公有云上，注册到Meta Server的是内网地址，本地开发环境无法直接连接，如果通过公网 SLB 对外暴露 Config Service的话，记得要设置 IP 白名单，避免数据泄露</span></span><br><span class="line"><span class="comment"># #</span></span><br><span class="line"><span class="comment"># #2. Config Service部署在docker环境中，注册到Meta Server的是docker内网地址，本地开发环境无法直接连接</span></span><br><span class="line"><span class="comment"># #</span></span><br><span class="line"><span class="comment"># #3. Config Service部署在kubernetes中，希望使用kubernetes自带的服务发现能力（Service）</span></span><br><span class="line"><span class="comment"># #</span></span><br><span class="line"><span class="comment"># #针对以上场景，可以通过直接指定Config Service地址的方式来跳过Meta Server服务发现</span></span><br><span class="line"><span class="comment"># #</span></span><br><span class="line"><span class="comment"># #要想让skywalking跳过Meta Server，只需要让参数apolloMeta为空，apolloConfig为Apollo的Config Service地址即可。</span></span><br><span class="line">SW_CONFIG_APOLLO=</span><br><span class="line"><span class="comment"># apollo 集群名称，默认即可</span></span><br><span class="line">SW_CONFIG_APOLLO_CLUSTER=default</span><br><span class="line"><span class="comment"># apollo 环境名称，默认DEV</span></span><br><span class="line">SW_CONFIG_APOLLO_ENV=DEV</span><br><span class="line"><span class="comment"># skywalking在Apollo中的项目名称，默认skywalking即可</span></span><br><span class="line">SW_CONFIG_APOLLO_APP_ID=skywalking</span><br><span class="line"></span><br><span class="line"><span class="comment"># skywalking OAP服务的rest地址和端口(上面配置文件设置)，若是集群，地址用逗号隔开</span></span><br><span class="line">SW_OAP_ADDRESS=192.168.91.100:12800</span><br></pre></td></tr></table></figure>

<p>运行docker compose</p>
<p>进入目录<code>/home/skywalking/docker-compose</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> /home/skywalking/docker-compose</span><br><span class="line">$ docker-compose -f docker-compose-boms.yml up -d </span><br></pre></td></tr></table></figure>

<p>查看日志：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker-compose -f docker-compose-boms.yml logs -f</span><br></pre></td></tr></table></figure>

<p>查看页面是否正常：</p>
<p><a target="_blank" rel="noopener" href="http://192.168.91.100:18080/">http://192.168.91.100:18080</a></p>
<h2 id="安装seata"><a href="#安装seata" class="headerlink" title="安装seata"></a>安装seata</h2><ol>
<li>加载镜像：</li>
</ol>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ docker load -i seataio/seata-server-1.4.2.tar</span><br><span class="line"><span class="comment"># 或者</span></span><br><span class="line">$ docker pull seataio/seata-server:1.4.2</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>创建挂载目录，并且从官方下载<a target="_blank" rel="noopener" href="https://github.com/seata/seata/blob/1.4.0/script/server/config/registry.conf">registry.conf</a> 和 <a target="_blank" rel="noopener" href="https://github.com/seata/seata/blob/1.4.0/script/server/config/file.conf">file.conf</a>拷贝到此目录中</li>
</ol>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">mkdir</span> -p /home/seata/config</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>在 <code>registry.conf</code> 文件中将 <code>config</code> 配置改为以下内容，<code>name</code> 的值为容器中对应的路径</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">config &#123;</span><br><span class="line">  type = &quot;file&quot;</span><br><span class="line"></span><br><span class="line">  file &#123;</span><br><span class="line">    name = &quot;file:/root/seata-config/file.conf&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>启动容器：</li>
</ol>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ docker run -d --name seata-server \</span><br><span class="line">        -p 8091:8091 \</span><br><span class="line">        -e SEATA_IP=10.10.103.56 \</span><br><span class="line">        -e SEATA_PORT=8091 \</span><br><span class="line">        -e SEATA_CONFIG_NAME=file:/root/seata-config/registry \</span><br><span class="line">        -v /home/seata/config:/root/seata-config  \</span><br><span class="line">        seataio/seata-server:1.4.2</span><br></pre></td></tr></table></figure>

<ol start="5">
<li>查看启动日志</li>
</ol>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ docker logs -f seata-server</span><br></pre></td></tr></table></figure>

<h2 id="安装青龙面板"><a href="#安装青龙面板" class="headerlink" title="安装青龙面板"></a>安装青龙面板</h2><p>项目地址：<a target="_blank" rel="noopener" href="https://github.com/whyour/qinglong/">GitHub</a></p>
<figure class="highlight dockerfile"><figcaption><span>docker-compose.yml</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">version: <span class="string">&#x27;2&#x27;</span></span><br><span class="line">services:</span><br><span class="line">  web:</span><br><span class="line">    image: whyour/qinglong:latest</span><br><span class="line">    volumes:</span><br><span class="line">      - ./data/config:/ql/config</span><br><span class="line">      - ./data/log:/ql/log</span><br><span class="line">      - ./data/db:/ql/db</span><br><span class="line">      - ./data/scripts:/ql/scripts</span><br><span class="line">      - ./data/repo:/ql/repo</span><br><span class="line">      - ./data/raw:/ql/raw</span><br><span class="line">      - ./data/jbot:/ql/jbot</span><br><span class="line">    ports:</span><br><span class="line">      - <span class="number">5700</span>:<span class="number">5700</span></span><br><span class="line">    environment:</span><br><span class="line">      - ENABLE_HANGUP=true</span><br><span class="line">      - ENABLE_WEB_PANEL=true</span><br><span class="line">    restart: always</span><br></pre></td></tr></table></figure>

<h2 id="安装consul"><a href="#安装consul" class="headerlink" title="安装consul"></a>安装consul</h2><ol>
<li>创建挂载目录：</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">mkdir</span> -p /home/consul</span><br></pre></td></tr></table></figure>

<ol start="2">
<li><p>新增配置文件：</p>
<p>路径：<code>/home/consul/config/acl.json</code></p>
</li>
</ol>
<figure class="highlight json"><figcaption><span>acl.json</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;acl_datacenter&quot;</span><span class="punctuation">:</span> <span class="string">&quot;buubiudatacentor&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;acl_master_token&quot;</span><span class="punctuation">:</span> <span class="string">&quot;p2BE1AtpwPbrxZdC6k+eXA==&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;acl_default_policy&quot;</span><span class="punctuation">:</span> <span class="string">&quot;deny&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;acl_down_policy&quot;</span><span class="punctuation">:</span> <span class="string">&quot;extend-cache&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>字段说明：</p>
<ul>
<li><p><code>acl_datacenter</code>:该配置项指定了对ACL信息具有权威性的数据中心。 必须提供它才能启用ACL。 所有Server实例和数据中心必须就ACL数据中心达成一致。必须在整个集群的Server节点上设置该配置项。在Consul 0.8及更高版本中，还可以启用代理级别的ACL。 有关详细信息，请参阅<a target="_blank" rel="noopener" href="https://www.consul.io/docs/guides/acl.html">ACL指南</a>。</p>
</li>
<li><p><code>acl_master_token</code>:该配置项只能用在<code>acl_datacenter</code>中的Server节点上。 如果该令牌不存在，则将使用管理级权限创建该令牌。 它允许操作员使用众所周知的令牌ID来引导ACL系统。</p>
</li>
<li><p><code>acl_default_policy</code>:该配置项可选的值为<code>allow</code>和<code>deny</code>。默认值为’allow’。默认的策略控制token在没有匹配的规则时的行为。</p>
<ul>
<li><p>在<code>allow</code>模式下，ACL规则是一个黑名单：任何没有被禁止的操作都是可以执行的。</p>
</li>
<li><p>在<code>deny</code>模式下，ACL规则是一个白名单，任何没有明确指定的操作都是被禁止的。</p>
<blockquote>
<p>注意：该配置项只有在配置了<code>acl_datacenter</code>后才起作用</p>
</blockquote>
</li>
</ul>
</li>
<li><p><code>acl_down_policy</code>:该配置项可选的值为<code>allow</code>，<code>deny</code>或<code>extend-cache</code>，　默认值是<code>extend-cache</code>。假如不能从<code>acl_datacenter</code>或<code>Leader</code>节点获取一个token的acl信息，则该配置项指定的策略被使用。</p>
<ul>
<li><code>allow</code>模式下，所有的操作都允许。</li>
<li><code>deny</code>模式下，所有的操作都被禁止。</li>
<li><code>extend-cache</code>模式下,使用缓存的 ACL规则并忽略这些规则的过期时间。如果一个不可缓存的ＡＣＬ的规则被使用，则当作<code>deny</code>策略来处理。</li>
</ul>
<p>路径：<code>/home/consul/config/server.json</code></p>
<figure class="highlight json"><figcaption><span>server.json</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;datacenter&quot;</span><span class="punctuation">:</span> <span class="string">&quot;buubiudatacentor&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;retry_join&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;0.0.0.0&quot;</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;retry_interval&quot;</span><span class="punctuation">:</span> <span class="string">&quot;15s&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;rejoin_after_leave&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;start_join&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;0.0.0.0&quot;</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;bootstrap_expect&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;server&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;ui&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;dns_config&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="attr">&quot;allow_stale&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span> <span class="attr">&quot;max_stale&quot;</span><span class="punctuation">:</span> <span class="string">&quot;5s&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;node_name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;consul&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure></li>
</ul>
<ol start="3">
<li>先不挂载目录启动容器，然后把相应的目录拷贝出来</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># agent consul核心，运行一个agent</span></span><br><span class="line"><span class="comment"># -server：定义agent运行在server模式，每个集群至少有一个server，建议每个集群的server不要超过5个</span></span><br><span class="line"><span class="comment"># -bootstrap-expect：在一个datacenter中期望提供的server节点数目，当该值提供的时候，consul一直等到达到指定sever数目的时候才会引导整个集群，该标记不能和bootstrap同时使用</span></span><br><span class="line"><span class="comment"># -ui：开启自带的ui web-server，可以通过HTTP API端口外部访问</span></span><br><span class="line">$ docker run -d --name consul consul:1.4.2 agent -server -bootstrap-expect=1 -ui</span><br><span class="line">$ docker <span class="built_in">cp</span> consul:/consul/data /home/consul/data</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>删除consul容器，重新以挂载目录启动:</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ docker run -d \</span><br><span class="line">  -p 8500:8500 \</span><br><span class="line">  -p 8600:8600/udp \</span><br><span class="line">  -v /home/consul/data:/consul/data \</span><br><span class="line">  -v /home/consul/config:/consul/config \</span><br><span class="line">  --name consul consul:1.4.2 \</span><br><span class="line">  agent -server -bootstrap-expect=1 -ui \</span><br><span class="line">  -<span class="built_in">bind</span>=0.0.0.0 \</span><br><span class="line">  -client=0.0.0.0</span><br></pre></td></tr></table></figure>
</div><div class="article-licensing box"><div class="licensing-title"><p>Docker安装常用服务</p><p><a href="https://blog.buubiu.com/Docker安装常用服务/">https://blog.buubiu.com/Docker安装常用服务/</a></p></div><div class="licensing-meta level is-mobile"><div class="level-left"><div class="level-item is-narrow"><div><h6>作者</h6><p>buubiu</p></div></div><div class="level-item is-narrow"><div><h6>发布于</h6><p>2021-03-08</p></div></div><div class="level-item is-narrow"><div><h6>更新于</h6><p>2024-01-25</p></div></div><div class="level-item is-narrow"><div><h6>许可协议</h6><p><a class="icons" rel="noopener" target="_blank" title="Creative Commons" href="https://creativecommons.org/"><i class="icon fab fa-creative-commons"></i></a><a class="icons" rel="noopener" target="_blank" title="Attribution" href="https://creativecommons.org/licenses/by/4.0/"><i class="icon fab fa-creative-commons-by"></i></a><a class="icons" rel="noopener" target="_blank" title="Noncommercial" href="https://creativecommons.org/licenses/by-nc/4.0/"><i class="icon fab fa-creative-commons-nc"></i></a></p></div></div></div></div></div><div class="article-tags is-size-7 mb-4"><span class="mr-2">#</span><a class="link-muted mr-2" rel="tag" href="/tags/Docker/">Docker</a></div><!--!--></article></div><!--!--><nav class="post-navigation mt-4 level is-mobile"><div class="level-start"><a class="article-nav-prev level level-item link-muted" href="/Dockerfile%E7%9A%84%E4%BD%BF%E7%94%A8/"><i class="level-item fas fa-chevron-left"></i><span class="level-item">Dockerfile的使用</span></a></div><div class="level-end"><a class="article-nav-next level level-item link-muted" href="/Docker%E4%B8%AD%E7%9A%84%E6%95%B0%E6%8D%AE%E5%8D%B7%E9%85%8D%E7%BD%AE/"><span class="level-item">Docker中的数据卷配置</span><i class="level-item fas fa-chevron-right"></i></a></div></nav><!--!--></div><!--!--><div class="column column-right is-4-tablet is-4-desktop is-4-widescreen  order-3 is-sticky"><div class="card widget" id="toc" data-type="toc"><div class="card-content"><div class="menu"><h3 class="menu-label">目录</h3><ul class="menu-list"><li><a class="level is-mobile" href="#基础安装步骤"><span class="level-left"><span class="level-item">1</span><span class="level-item">基础安装步骤</span></span></a></li><li><a class="level is-mobile" href="#安装mysql"><span class="level-left"><span class="level-item">2</span><span class="level-item">安装mysql</span></span></a></li><li><a class="level is-mobile" href="#安装tomcat"><span class="level-left"><span class="level-item">3</span><span class="level-item">安装tomcat</span></span></a></li><li><a class="level is-mobile" href="#安装redis"><span class="level-left"><span class="level-item">4</span><span class="level-item">安装redis</span></span></a></li><li><a class="level is-mobile" href="#安装nginx"><span class="level-left"><span class="level-item">5</span><span class="level-item">安装nginx</span></span></a></li><li><a class="level is-mobile" href="#安装elasticsearch"><span class="level-left"><span class="level-item">6</span><span class="level-item">安装elasticsearch</span></span></a></li><li><a class="level is-mobile" href="#安装kibana"><span class="level-left"><span class="level-item">7</span><span class="level-item">安装kibana</span></span></a></li><li><a class="level is-mobile" href="#安装mariadb"><span class="level-left"><span class="level-item">8</span><span class="level-item">安装mariadb</span></span></a></li><li><a class="level is-mobile" href="#安装nacos"><span class="level-left"><span class="level-item">9</span><span class="level-item">安装nacos</span></span></a></li><li><a class="level is-mobile" href="#安装apollo"><span class="level-left"><span class="level-item">10</span><span class="level-item">安装apollo</span></span></a></li><li><a class="level is-mobile" href="#安装Zookeeper"><span class="level-left"><span class="level-item">11</span><span class="level-item">安装Zookeeper</span></span></a></li><li><a class="level is-mobile" href="#安装Kafka"><span class="level-left"><span class="level-item">12</span><span class="level-item">安装Kafka</span></span></a></li><li><a class="level is-mobile" href="#安装Logstash"><span class="level-left"><span class="level-item">13</span><span class="level-item">安装Logstash</span></span></a></li><li><a class="level is-mobile" href="#安装Filebeat"><span class="level-left"><span class="level-item">14</span><span class="level-item">安装Filebeat</span></span></a></li><li><a class="level is-mobile" href="#安装Skywalking"><span class="level-left"><span class="level-item">15</span><span class="level-item">安装Skywalking</span></span></a></li><li><a class="level is-mobile" href="#安装seata"><span class="level-left"><span class="level-item">16</span><span class="level-item">安装seata</span></span></a></li><li><a class="level is-mobile" href="#安装青龙面板"><span class="level-left"><span class="level-item">17</span><span class="level-item">安装青龙面板</span></span></a></li><li><a class="level is-mobile" href="#安装consul"><span class="level-left"><span class="level-item">18</span><span class="level-item">安装consul</span></span></a></li></ul></div></div><style>#toc .menu-list > li > a.is-active + .menu-list { display: block; }#toc .menu-list > li > a + .menu-list { display: none; }</style><script src="/js/toc.js" defer></script></div></div></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/"><img src="/img/common/favicon.ico" alt="buubiu&#039;s技术分享主页" height="28"></a><p class="is-size-7"><span>&copy; 2024 buubiu</span>  Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a><span>  <img src="/img/common/foot-ga.png">  <a title="苏公网安备 32032102000187号" href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=32032102000187" target="_blank" rel="noopener">苏公网安备 32032102000187号</a></span><span>  <img src="/img/common/foot-icp.png">  <a title="苏ICP备2021016911号-1" href="https://beian.miit.gov.cn/" target="_blank" rel="noopener">苏ICP备2021016911号-1</a></span><br><span id="busuanzi_container_site_uv">共<span id="busuanzi_value_site_uv">0</span>个访客</span></p></div><div class="level-end"><div class="field has-addons"><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Attribution 4.0 International" href="https://creativecommons.org/licenses/by/4.0/"><i class="fab fa-creative-commons-by"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/bufx"><i class="fab fa-github"></i></a></p></div></div></div></div></footer><script src="https://cdnjs.loli.net/ajax/libs/jquery/3.3.1/jquery.min.js"></script><script src="https://cdnjs.loli.net/ajax/libs/moment.js/2.22.2/moment-with-locales.min.js"></script><script src="https://cdnjs.loli.net/ajax/libs/clipboard.js/2.0.4/clipboard.min.js" defer></script><script>moment.locale("zh-cn");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script src="/js/column.js"></script><a id="back-to-top" title="回到顶端" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/js/back_to_top.js" defer></script><!--!--><!--!--><!--!--><!--!--><script src="https://cdnjs.loli.net/ajax/libs/cookieconsent/3.1.1/cookieconsent.min.js" defer></script><script>window.addEventListener("load", () => {
      window.cookieconsent.initialise({
        type: "info",
        theme: "edgeless",
        static: false,
        position: "bottom-left",
        content: {
          message: "此网站使用Cookie来改善您的体验。",
          dismiss: "知道了！",
          allow: "允许使用Cookie",
          deny: "拒绝",
          link: "了解更多",
          policy: "Cookie政策",
          href: "https://www.cookiesandyou.com/",
        },
        palette: {
          popup: {
            background: "#edeff5",
            text: "#838391"
          },
          button: {
            background: "#4b81e8"
          },
        },
      });
    });</script><script src="https://cdnjs.loli.net/ajax/libs/lightgallery/1.10.0/js/lightgallery.min.js" defer></script><script src="https://cdnjs.loli.net/ajax/libs/justifiedGallery/3.8.1/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><script type="text/javascript" id="MathJax-script" async>MathJax = {
      tex: {
        inlineMath: [['$', '$'], ['\\(', '\\)']]
      },
      svg: {
        fontCache: 'global'
      },
      chtml: {
        matchFontHeight: false
      }
    };</script><script src="https://cdnjs.loli.net/ajax/libs/mathjax/3.2.2/es5/tex-mml-chtml.js"></script><!--!--><!--!--><!--!--><script src="/js/main.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="想要查找什么..."></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div></div></div><script src="/js/insight.js" defer></script><script>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/content.json"}, {"hint":"想要查找什么...","untitled":"(无标题)","posts":"文章","pages":"页面","categories":"分类","tags":"标签"});
        });</script></body></html>